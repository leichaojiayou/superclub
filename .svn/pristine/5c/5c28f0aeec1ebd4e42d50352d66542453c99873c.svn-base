var app = getApp()
const clubApi = app.api("clubApi")
const actApi = app.api("actApi")

Page({
    data: {
        clubId: 0,
        threelabel: [{
                txt: '会员',
                amount: '--'
            },
            {
                txt: '本月活动',
                amount: '--'
            },
            {
                txt: '本月报名',
                amount: '--'
            },
        ],
        item: [{
                img: 'https://cdn.51julebu.com/xiaochengxu/image/active.png',
                content: '发布活动'
            },
            {
                img: 'https://cdn.51julebu.com/xiaochengxu/image/member+.png',
                content: '招募会员'
            },
            {
                img: 'https://cdn.51julebu.com/xiaochengxu/image/msg.png',
                content: '免费信息'
            },
            {
                img: 'https://cdn.51julebu.com/xiaochengxu/image/list.png',
                content: '管理消息'
            }
        ],
        //分页
        loading: false,
        start: 0,
        hasMore: true,
        acts: [],

        club: {
            joinUnCheckNum: 0,
            codeHehe: '',
        },
        hideQrCode: true,
        item3: [{
            img: '',
            name: '潍坊市马拉松运动协会2017黄河口东营-国际马拉松赛报名啊啊啊啊啊啊啊啊啊啊啊啊',
            time: '2017.12.21 17:30',
            club_name: '俱乐部俱乐部名称',
            money: '￥230.00',
            freemsg: '0',
            enlistnumber: '3'
        }],
        refreshClub: false,
        backOrTo: 0, //跳转标志，如果从俱乐部主页跳转过来，set 1，这时从管理主页跳俱乐部主页，只需要返回即可 
    },

    onLoad(params) {
        let clubId = params.clubId;
        this.data.clubId = clubId
        this.data.backOrTo = params.backOrTo | 0
        this.loadClubInfo()
        this.loadActs()
    },

    onShow() {
        if (this.data.refreshClub) {
            this.data.refreshClub = false
            this.loadClubInfo()
        }
    },

    loadClubInfo() {
        //获取俱乐部详情
        let clubId = this.data.clubId
        let that = this
        clubApi.clubDetailLite({
            loading: true,
            data: {
                club_id: clubId
            }
        }, (res) => {
            let clubInfo = res.data.club;
            clubInfo.clubimg = clubInfo.logo
            clubInfo.clubicon = app.util.getClubImg(clubInfo.score, false)
            if (clubInfo.title.length > 25) {
                clubInfo.clubname = clubInfo.title.slice(0, 25) + "..."
            } else {
                clubInfo.clubname = clubInfo.title
            }
            clubInfo.clubcode = clubInfo.qrcode
            clubInfo.clubtext = "ID:" + clubInfo.clubNo + "  成员" + clubInfo.memberCount
            that.setData({
                club: clubInfo,
                threelabel: [{
                        txt: '会员',
                        amount: clubInfo.memberCount
                    },
                    {
                        txt: '本月活动',
                        amount: clubInfo.monthActCount
                    },
                    {
                        txt: '本月报名',
                        amount: clubInfo.monthApplyCount
                    },
                ]
            })
        })
    },

    loadActs() {
        if (this.data.loading) return
        if (!this.data.hasMore) return
        let that = this
        this.data.loading = true
        let start = this.data.start
        //获取俱乐部管理活动列表
        actApi.manageActs({
                data: {
                    user_id: app.session.getUserInfo().userID,
                    start: start,
                    count: 15
                }
            },
            (res) => {
                that.data.loading = false
                let activities = res.data.activities;
                activities.forEach(e => {
                    e.time = app.util.formatTime2(e.begin)
                    e.money = app.util.formatMoney(e.cost * 100)
                    e.timeFlag = e.activityStatus == 0
                    e.activityStatusText = e.activityStatus == 0 ? '报名中' : '已结束'
                    e.activityStatusColor = e.activityStatus == 0 ? 'rgb(145, 213, 192)' : 'rgb(227, 192, 163)'
                })
                let renderArray = that.data.acts.concat(activities)
                that.setData({
                    acts: renderArray,
                    start: res.data.start,
                    hasMore: res.data.more == 1
                })
            }, res => {
                that.data.loading = false
            }
        )
    },

    nato: function (e) {
        var that = this
        switch (e.currentTarget.id) {
            case '0': //发布活动
                app.wxService.navigateTo("organize/act_op/act_op")
                break;
            case '1': //招募会员
                that.showClubQrCode()
                break;
            case '2': //免费短信
                app.wxService.navigateTo("index/mfdx/mfdx")
                break;
            case '3': //待办事项
                app.wxService.navigateTo("index/manage_messages/manage_messages", {
                    clubId: that.data.clubId,
                    num: that.data.club.joinUnCheckNum
                })
                break;
        }
    },

    showClubQrCode() {
        let that = this
        let club = that.data.club
        if (club.clubQrCode) {
            club.codeHehe = 'opacity:1;pointer-events:auto;'
            club.clubcode = club.clubQrCode
            that.setData({
                club: club
            })
            return
        }
        //生成俱乐部二维码
        let path = '/pages/club/clubhome/clubhome?clubId=' + that.data.clubId
        app.api("systemApi").createQrCode(path, res => {
            let qrcode = res.data.result;
            let club = that.data.club
            club.clubQrCode = qrcode
            that.setData({
                club: club
            })
            that.showClubQrCode()
        }, res => {
            app.wxService.showToast('生成二维码失败')
        })
    },

    clubModify: function () {
        this.data.refreshClub = true
        app.wxService.navigateTo('club/clubInformation/clubInformation?clubId=' + this.data.clubId)
    },

    clubDetail: function () {
        if (this.data.backOrTo != 0) {
            app.wxService.navigateBack()
        } else {
            app.wxService.navigateTo('club/clubhome/clubhome', {
                clubId: this.data.clubId,
                backOrTo: 1
            })
        }
    },

    actDetail: function (e) {
        let activityId = e.currentTarget.dataset.id;
        let clubId = this.data.clubId
        app.wxService.navigateTo("../../manage/manage_activity/manage_activity", {
            actId: activityId,
            clubID: clubId
        })
    },

    closeCode: function () {
        let club = this.data.club
        club.codeHehe = ''
        this.setData({
            club: club
        })
    },

    onShareAppMessage: function () {
        return {
            title: '一起来玩超级俱乐部吧',
            path: '/pages/club/clubhome/clubhome?clubId=' + this.data.clubId
        }
    }
})