// pages/create_club/create_club.js
var app = getApp()
var clubApi = app.api("clubApi")
var userApi = app.api("userApi")
var systemApi = app.api("systemApi")

Page({
  data: {
    choose: 'è¯·é€‰æ‹©',
    input: 'è¾“å…¥',
    txt: 'å†™ä¸€æ®µç®€ä»‹æè¿°ä½ çš„ä¿±ä¹éƒ¨å§',

    //éªŒè¯æ‰‹æœºçš„å­—æ®µ
    authCode: "",
    interval: "",
    authDialog: {
      phone: '',
      modalShowStyle: "",
      status: 0, //0: æ˜¾ç¤ºå‘é€éªŒè¯ç çš„æŒ‰é’® 1: å€’æ•°ä¸­
    },
    countDown: 30,

    logo: "",
    remoteLogo: "",
    title: "",
    location: "",
    cityId: "",
    setupTime: "",
    features: [],
    slogan: "",
    desc: "",
    charger: "",
    phone: ""
  },

  onLoad() {
    app.event.addListener('club_fill', this)
  },

  onUnload() {
    app.event.removeListener('club_fill')
  },

  //ä¿±ä¹éƒ¨logo
  clickLogo() {
    let that = this
    wx.chooseImage({
      count: 1, // é»˜è®¤9
      sizeType: ['compressed'], // å¯ä»¥æŒ‡å®šæ˜¯åŸå›¾è¿˜æ˜¯å‹ç¼©å›¾ï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
      sourceType: ['album', 'camera'], // å¯ä»¥æŒ‡å®šæ¥æºæ˜¯ç›¸å†Œè¿˜æ˜¯ç›¸æœºï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
      success: function (res) {
        // è¿”å›é€‰å®šç…§ç‰‡çš„æœ¬åœ°æ–‡ä»¶è·¯å¾„åˆ—è¡¨ï¼ŒtempFilePathå¯ä»¥ä½œä¸ºimgæ ‡ç­¾çš„srcå±æ€§æ˜¾ç¤ºå›¾ç‰‡
        var tempFilePaths = res.tempFilePaths
        that.setData({
          logo: tempFilePaths[0],
          remoteLogo: "",
        })
      }
    })
  },

  //ä¿±ä¹éƒ¨åç§°
  clickName() {
    app.wxService.navigateTo("club/modify/clubName/clubName?type=1&title=" + this.data.title)
  },

  //æ‰€åœ¨åœ°
  clickLocation() {
    app.wxService.navigateTo("club/modify/province/province?type=1")
  },

  //åˆ›ç«‹æ—¶é—´
  clickSetupTime() {
    //app.wxService("club/modify/")
  },

  //ä¸»æ‰“é¡¹ç›®
  clickFeature() {
    app.wxService.navigateTo("club/modify/masterProjects/masterProjects?type=1")
  },

  //å®£è¨€
  clickSlogan() {
    app.wxService.navigateTo("club/modify/declaration/declaration?type=1&slogan=" + this.data.slogan)
  },

  //ç®€ä»‹
  clickDesc() {
    app.wxService.navigateTo("club/modify/description/description?type=1&description=" + this.data.desc)
  },
  //è´Ÿè´£äºº
  inputCharger(e) {
    this.data.charger = e.detail.value
  },
  //è”ç³»æ–¹å¼
  inputPhone(e) {
    this.data.phone = e.detail.value
  },

  validate() {
    let errorMsg = ''
    if (this.data.title == '') {
      errorMsg = 'ä¿±ä¹éƒ¨åç§°ä¸èƒ½ä¸ºç©º'
    } else if (this.data.cityId == '') {
      errorMsg = 'ä¿±ä¹éƒ¨æ‰€åœ¨åœ°ä¸èƒ½ä¸ºç©º'
    } else if (this.data.features.length == 0) {
      errorMsg = 'ä¿±ä¹éƒ¨ä¸»æ‰“é¡¹ç›®ä¸èƒ½ä¸ºç©º'
    } else if (this.data.slogan == '') {
      errorMsg = 'ä¿±ä¹éƒ¨å®£è¨€ä¸èƒ½ä¸ºç©º'
    } else if (this.data.desc == '') {
      errorMsg = 'ä¿±ä¹éƒ¨ç®€ä»‹ä¸èƒ½ä¸ºç©º'
    } else if (this.data.charger == '') {
      errorMsg = 'è´Ÿè´£äººä¸èƒ½ä¸ºç©º'
    } else if (this.data.phone == '') {
      errorMsg = 'è”ç³»å·ç ä¸èƒ½ä¸ºç©º'
    } else if (this.data.phone.length != 11) {
      errorMsg = 'è”ç³»å·ç éæ³•'
    }
    if (errorMsg != '') {
      app.wxService.showToast(errorMsg)
      return false
    }
    //æ ¡éªŒé€šè¿‡
    return true
  },

  createClub() {
    const data = this.data
    if (this.validate() == false) {
      //ç¼ºå°‘å¿…å¡«é¡¹
      return
    }
    if (app.session.isTempUser()) {
      //ä¸´æ—¶ç”¨æˆ·ï¼Œéœ€è¦å…ˆç»‘å®šæ‰‹æœº
      this.setData({
        modalShowStyle: "opacity:1;pointer-events:auto;"
      })
      this.bindPhone()
      return
    }

    if (data.remoteLogo === '') {
      //å…ˆä¸Šä¼ logoåˆ°æœåŠ¡å™¨
      this.uploadLogo()
      return
    }

    let features = ''
    data.features.forEach(e => {
      if (features != '') {
        features += ','
      }
      features += e.id
    })
    clubApi.createClub({
        method: 'POST',
        data: {
          title: data.title,
          logo: data.remoteLogo,
          description: data.desc,
          slogan: data.slogan,
          city_id: data.cityId,
          need_join_check: "0",
          contact_name: data.charger,
          contact_tel: data.phone,
          feature: features
        }
      }, res => {
        //æˆåŠŸ
        let pages = getCurrentPages()
        let prevPage = pages[pages.length - 2]
        prevPage.setData({
          refreshClubs: true
        })
        app.wxService.showModal({
          title: "åˆ›å»ºç”³è¯·å·²æäº¤",
          content: "ç”³è¯·å·²æäº¤ï¼Œå·¥ä½œäººå‘˜å°†åœ¨3ä¸ªå·¥ä½œæ—¥å†…è”ç³»æ‚¨ï¼Œè¯·è€å¿ƒç­‰å€™å¹¶ä¿æŒç”µè¯ç•…é€š",
          showCancel: false,
        }, res => {
          if (res.confirm) {
            app.wxService.navigateBack(1)
          }
        })
      },
      res => {
        //å¤±è´¥
        let errorData = app.util.getErrorMsg(res)
        app.wxService.showToast(errorData.title + "," + errorData.content)
      })
  },

  uploadLogo() {
    let that = this
    let localPath = this.data.logo
    systemApi.uploadImage(localPath, res => {
      console.log(res)
      let remoteUrl = res.data.url
      that.setData({
        remoteLogo: remoteUrl
      })
      that.createClub()
    }, res => {
      //ä¸Šä¼ å›¾ç‰‡å¤±è´¥
      app.wxService.showToast("ä¸Šä¼ ä¿±ä¹éƒ¨å¤´åƒå¤±è´¥")
    })
  },

  /**
   * ä¸´æ—¶ç”¨æˆ·ï¼Œç»‘å®šæ‰‹æœºå·
   */
  bindPhone() {
    let that = this
    let phone = this.data.phone
    userApi.sendAuthCode({
      data: {
        auth_type: 2,
        phone: phone
      }
    }, res => {
      let interval = setInterval(() => {
        let leftTime = that.data.countDown - 1;
        let authDialog = that.data.authDialog
        if (leftTime > 0) {
          that.setData({
            countDown: leftTime
          })
        } else {
          clearInterval(interval)
          authDialog.status = 0
          that.setData({
            authDialog: authDialog,
            countDown: 30
          })
        }
      }, 1000)
      let authDialog = that.data.authDialog
      authDialog.phone = phone
      authDialog.status = 1
      authDialog.focus = true
      authDialog.modalShowStyle = "opacity:1;pointer-events:auto;"
      that.setData({
        authDialog: authDialog,
        interval: interval,
        countDown: 30
      })
    }, res => {
      let errorData = app.util.getErrorMsg(res)
      let errorMsg = errorData.content
      if (errorMsg == '') {
        errorMsg = "å‘é€éªŒè¯ç å¤±è´¥"
      }
      app.wxService.showToast(errorMsg)
    })
  },

  getAuthCode() {
    //ç‚¹å‡»å‘é€éªŒè¯ç 
    this.bindPhone()
  },

  authInput(e) {
    //è¾“å…¥éªŒè¯ç 
    this.data.authCode = e.detail.value
  },

  touchCancel() {
    //ç‚¹å‡»å–æ¶ˆ
    clearInterval(this.data.interval)
    let authDialog = this.data.authDialog
    authDialog.modalShowStyle = ""
    authDialog.focus = false
    this.setData({
      authDialog: authDialog,
    })
  },

  touchAddNew() {
    let that = this
    if (this.data.authCode == '') {
      app.wxService.showToast('éªŒè¯ç ä¸èƒ½ä¸ºç©º')
      return
    }
    clearInterval(this.data.interval)
    //ç‚¹å‡»ç¡®å®š
    let authDialog = this.data.authDialog
    authDialog.modalShowStyle = ""
    authDialog.focus = false
    this.setData({
      authDialog: authDialog,
    })

    let code = this.data.authCode
    let phone = this.data.phone
    userApi.bindPhone({
      method: 'POST',
      data: {
        code: code,
        phone: phone,
      }
    }, res => {
      //ç»‘å®šæ‰‹æœºæˆåŠŸ, é‡æ–°ç™»å½•ä¸€ä¸‹
      getApp().relogin(res => {
        that.createClub()
      })
    }, res => {
      let errorData = app.util.getErrorMsg(res)
      let errorMsg = errorData.content
      if (errorMsg == '') {
        errorMsg = "ç»‘å®šæ‰‹æœºå·ç å¤±è´¥"
      }
      app.wxService.showToast(errorMsg)
    })
  },

})