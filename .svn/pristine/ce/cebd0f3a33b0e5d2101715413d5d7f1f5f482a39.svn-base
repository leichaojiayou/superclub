
// pages/clubhome/clubhome.js
const App = getApp();
const clubApi = App.api('clubApi');
const wxService = App.wxService;
const config = require('../../../utils/constant')
Page({
  data: {
    img: {
      imgStart: config.CDN_URL + '/xiaochengxu/image/stars.png',
      imgRight: config.CDN_URL + '/xiaochengxu/image/right-errow.png',
      imgQrcode: config.CDN_URL + '/xiaochengxu/image/qrcode.png',
      imgMember: config.CDN_URL + '/xiaochengxu/image/member@2x.png',
      imgAct: config.CDN_URL + '/xiaochengxu/image/active.png',
    },
    start: 0,
  },

  onLoad: function (e) {
    this.setData({
      clubId: e.clubId
    });
    this.getClubIndex(true);
    this.getMamberActivity();
  },

  /**
   * 获取俱乐部主页
   */
  getClubIndex: function (loading) {
    const that = this;
    let param = {}
    let data = {
      club_id: that.data.clubId
    }
    param.data = data;
    if (loading) {
      param.loading = loading;
    }
    clubApi.clubIndex(param, (res) => {
      that.setData({
        club: res.data.club
      })
    });
  },

  /**
   * 获取用户活动信息
   */
  getMamberActivity: function () {
    if (this.data.more == 0) return
    const that = this;
    let param = {}
    let data = {
      club_id: that.data.clubId,
      start: that.data.start,
      count: 10,
    }
    param.data = data;
    clubApi.clubActs(param, (res) => {
      let data = res.data;
      if (data) {
        let activities = data.acts;
        activities.forEach((e) => {
          e.timeFlag = App.util.compareDate(new Date(e.endTime));
          e.begin = App.util.formatTime2(e.beginTime);
          e.end = App.util.formatTime2(e.endTime);
        });
        let oldActs = that.data.activity || [];
        activities = oldActs.concat(activities);
        that.setData({
          activity: activities,
          start: data.start,
          more: data.more
        })
      }
    })
  },

  lower: function (e) {
    this.getMamberActivity()
  },

  actDetail: function (e) {
    wxService.navigateTo('activity/act_detail/act_detail', {
      activityID: e.currentTarget.dataset.actid,
      clubId: this.data.clubId
    })
  },

  toClubInformation: function () {
    wxService.navigateTo('club/clubInformation/clubInformation', { club_no: 30328 })
  },

  onShow: function () {
    const data = this.data;
    if (data.club) {
      this.setData({
        modifyTitle: data.modifyTitle || data.club.title,
        modifyLogo: data.modifyLogo || data.club.logo,
        modifyFeatures: data.modifyFeatures || data.club.features,
        modifySlogan: data.modifySlogan || data.club.slogan
      })
    }
  }


})
