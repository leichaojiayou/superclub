const app = getApp();
const actApi = app.api("actApi");
const utils = app.util;
let activityId, applyId;//活动ID、报名Id

let inputData = new Object();
Page({
    data: {
        type: 0,//0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式
        isCost: false,
        selectTicketIndex: 0,
        selectTicket: {},//已选择的票价
        tickets: [],//票价列表
        fields: [],//需要填写的信息列表
    },
    ticketSelect: function (e) {//费用选择器
        this.setData({
            selectTicketIndex: e.detail.value,
            selectTicket: this.data.tickets[e.detail.value],
        })
    },
    pickerEvent: function (e) {//选择器事件
        let that = this;
        let index = e.currentTarget.dataset.index;
        let item = e.currentTarget.dataset.item;
        that.data.fields[index].defaultValue = item.option[e.detail.value];
        this.setData({
            fields: that.data.fields,
        });
        inputData[item.fieldName] = item.option[e.detail.value];
        console.log(inputData, e);
    },
    inputEvent: function (e) {//输入框事件
        let index = e.currentTarget.dataset.index;
        let item = e.currentTarget.dataset.item;

        inputData[item.fieldName] = e.detail.value;
        console.log(inputData);
    },
    /**
     * type :0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式
     * @param param
     */
    onLoad: function (param) {
        let that = this;
        activityId = param.activityId;
        that.setData({//是否帮报名填写模式
            type: param.type
        });
        if (that.data.type == 0) {
            app.wxService.setNavigationBarTitle("报名活动");
            that.loadApplyInfo();
        } else if (that.data.type == 1) {
            app.wxService.setNavigationBarTitle("帮人报名");
            that.loadApplyInfo();
        } else if (that.data.type == 2) {
            app.wxService.setNavigationBarTitle("修改报名资料");
            applyId = param.applyId;
            that.loadApplyInfo();
        }
        console.log(param);
    },
    loadApplyInfo: function () {//获取报名需要填写的信息
        let that = this;
        actApi.getApplyInfo({
            data: {
                activity_id: activityId,
                apply_id: applyId,
            },
        }, function (res) {
            console.log(JSON.stringify(res.data));
            let data = res.data;
            let fields = res.data.fields;
            let tickets = res.data.tickets;
            fields.forEach(function (item) {
                if (item.fieldType == 2 && item.option) {//选择
                    item.option = item.option.split(',');
                    if (!item.defaultValue) {
                        item.defaultValue = item.option[0];
                    } else {
                        item.select = item.option.indexOf(item.defaultValue);
                    }
                    inputData[item.fieldName] = item.option[0];
                } else {//文本填写
                    if (that.data.type == 2) {
                        inputData[item.fieldName] = item.defaultValue;
                    } else {
                        inputData[item.fieldName] = null;
                    }
                    if (item.fieldName == "手机") {
                        item.inputType = "number";
                        item.placeHolder = "请填写手机";
                        item.maxText = 11;
                    } else {
                        item.inputType = "text";
                        item.maxText = 30;
                    }
                    if (item.fieldName == "昵称") {
                        item.placeHolder = "请填写昵称";
                        item.maxText = 10;
                    }
                }
            });

            if (tickets && tickets.length != 0) {//付费活动
                let tickets = res.data.tickets;
                let selectTicket = data.tickets[0];
                tickets.forEach(function (item) {
                    item.desc = item.name + "：" + (item.cost / 100);
                });
                that.setData({
                    isCost: true,
                    fields: data.fields,
                    selectTicketIndex: 0,
                    selectTicket: selectTicket,
                    tickets: tickets,
                });
            } else {//免费活动
                that.setData({
                    isCost: false,
                    fields: data.fields,
                });
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '报名信息加载失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
        });
    },
    checkInput: function () {//检查填写信息是否有错误
        for (let item of this.data.fields) {
            let value = inputData[item.fieldName];
            if (!value || value.lengh == 0) {
                app.wxService.showModal({title: "报名信息填写错误", content: item.fieldName + "为空"});
                return false;
            }
        }
        return true;
    },
    greenButton: function () {////立即报名、或”保存“按钮
        //type: 0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式
        let that = this;
        if (that.data.type == 0) {
            that.apply();
        } else if (that.data.type == 1) {
            app.wxService.showToast("进入applyList");
            return;
            let applyInfo = {
                isCost: that.data.isCost,
                selectTicketIndex: that.data.selectTicketIndex,
                selectTicket: that.data.selectTicket,//已选择的票价
                tickets: that.data.tickets,//票价列表
                fields: that.data.fields,//需要填写的信息列表
            };
            app.wxService.navigateTo("activity/applylist/applylist", {
                activityId: activityId,
                type: 1,
                applyInfo: applyInfo,
            })
        } else if (this.data.type == 2) {
            that.update();
        }
    },
    update: function () {//修改报名资料
        let that = this;
        let data = JSON.stringify(inputData);
        console.log(data);
        if (this.checkInput()) {
            actApi.updateApplyInfo({
                    data: {
                        actID: activityId,
                        data: data,
                        ticketID: that.data.selectTicket.ticketID,
                        phone: inputData["手机"],
                        applyPlatform: 3,
                        applyID: applyId,
                    },
                    method: "POST",
                }
                , function (res) {
                    let pages = getCurrentPages();
                    let currPage = pages[pages.length - 1];   //当前页面
                    let prevPage = pages[pages.length - 2];  //上一个页面
                    prevPage.recvData(1);
                    app.wxService.navigateBack();
                }, function (res) {
                    let errorMsg = utils.getErrorMsg(res);
                    app.wxService.showModal({title: '保存失败', content: errorMsg.title + '；' + errorMsg.content})
                }, function (res) {
                    console.log(res)
                });
        }
    },
    apply: function () {//立即报名
        let that = this;
        let data = JSON.stringify(inputData);
        console.log(data);
        if (this.checkInput()) {
            actApi.actApplySelf({
                    data: {
                        activity_id: activityId,
                        data: data,
                        ticket_id: that.data.selectTicket.ticketID,
                        phone: inputData["手机"],
                        paid: 0,
                        applyPlatform: 3,
                    },
                    method: "POST",
                }
                , function (res) {
                    app.wxService.showToast("报名成功");
                    let result = res.data.result;
                    if (result > 0) {//报名成功，返回活动详情页面，并带回值
                        let pages = getCurrentPages();
                        let currPage = pages[pages.length - 1];   //当前页面
                        let prevPage = pages[pages.length - 2];  //上一个页面
                        prevPage.recvData(result);
                        app.wxService.navigateBack();
                    } else {//报名失败
                        // -1: 需要验证手机, 需要弹出验证码输入框.
                        // -2: 手机验证码验证失败.
                        // -3: 临时用户输入的手机号已关联了老用户.
                        let error = "";//报名错误信息
                        switch (result) {
                            case -1:
                                error = '需要验证手机, 需要弹出验证码输入框.';
                                break;
                            case -2:
                                error = '手机验证码错误';
                                break;
                            case -3:
                                error = '手机号已关联了老用户';
                                break;
                        }
                        app.wxService.showModal({title: '报名失败', content: errorMsg.title + '；' + errorMsg.content})
                    }
                }, function (res) {
                    let errorMsg = utils.getErrorMsg(res);
                    app.wxService.showModal({title: '报名失败', content: errorMsg.title + '；' + errorMsg.content})
                }, function (res) {
                    console.log(res)
                });
        }
    },
    helpApply: function (e) {//帮人报名
        app.wxService.navigateTo("activity/applylist/applylist")
    }
});