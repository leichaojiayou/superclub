const app = getApp();
const actApi = app.api("actApi");
const utils = app.util;
let activityId;//活动ID

let inputData = new Object();
Page({
    data: {
        isCost: false,
        selectTicketIndex: 0,
        selectTicket: {}
        ,//已选择的票价
        rightArrow: "https://cdn.51julebu.com/xiaochengxu/image/right-errow.png",
        tickets: [],//票价列表
        fields: [],//需要填写的信息列表
    },
    ticketSelect: function (e) {//费用选择器
        this.setData({
            selectTicketIndex: e.detail.value,
            selectTicket: this.data.tickets[e.detail.value],
        })
    }
    ,
    pickerEvent: function (e) {//选择器事件
        let that = this;
        let index = e.currentTarget.dataset.index;
        let item = e.currentTarget.dataset.item;
        that.data.fields[index].defaultValue = item.option[e.detail.value];
        this.setData({
            fields: that.data.fields,
        })
        //inputData.set(item.fieldName, item.option[e.detail.value]);
        inputData[item.fieldName] = item.option[e.detail.value];
        console.log(inputData, e);
    }
    ,
    inputEvent: function (e) {//输入框事件
        let index = e.currentTarget.dataset.index;
        let item = e.currentTarget.dataset.item;
        //inputData.set(item.fieldName, e.detail.value);

        inputData[item.fieldName] = e.detail.value;
        console.log(inputData);
    }
    ,
    onLoad: function (options) {
        let that = this;
        if (options.activityId) {
            activityId = options.activityId;
        }
        console.log(activityId);
        actApi.getApplyInfo({
            data: {
                activity_id: activityId,
            },
        }, function (res) {
            let data = res.data;
            let fields = res.data.fields;
            fields.forEach(function (item) {
                if (item.fieldType == 2 && item.option) {//选择
                    item.option = item.option.split(',');
                    //inputData.set(item.fieldName, item.option[0]);
                    inputData[item.fieldName] = item.option[0];
                } else {//文本填写
                    //inputData.set(item.fieldName, null);

                    inputData[item.fieldName] = null;
                    if (item.fieldName == "手机") {
                        item.inputType = "number"
                    } else {
                        item.inputType = "text"
                    }
                }
            });

            if (typeof tickets == Array && tickets.length != 0) {//付费活动
                let tickets = res.data.tickets;
                let selectTicket = data.tickets[0];
                tickets.forEach(function (item) {
                    item.desc = item.name + "：" + (item.cost / 100);
                });
                that.setData({
                    fields: data.fields,
                    selectTicket: selectTicket,
                    tickets: tickets,
                });
            } else {
                that.setData({
                    fields: data.fields,
                });
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            wx.showModal({title: '报名信息加载失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(JSON.stringify(res.data))
        });
    }
    ,
    checkInput: function () {
        for (let item of this.data.fields) {
            let value = inputData[item.fieldName];
            if (!value || value.lengh == 0) {
                app.wxService.showModal({title: "报名信息填写错误", content: item.fieldName + "为空"});
                return false;
            }
        }
        return true;
    }
    ,
    apply: function (e) {//立即报名
        let that = this;
        let data = JSON.stringify(inputData);
        ;
        /*        inputData.forEach(function (key, value) {
         data = data +
         });*/
        console.log(data);
        if (this.checkInput()) {
            actApi.actApplySelf({
                    data: {
                        activity_id: activityId,
                        data: data,
                        ticket_id: 0,
                        phone: inputData["手机"],
                        paid: 0,
                        applyPlatform: 3,
                    }
                }
                , function (res) {
                    app.wxService.showToast("报名成功");
  /*                  var pages = getCurrentPages();
                    var currPage = pages[pages.length - 1];   //当前页面
                    var prevPage = pages[pages.length - 2];  //上一个页面
                    // 直接调用上一个页面的setData()方法，把数据存到上一个页面中去
                    prevPage.setData({
                        mydata: {a: 1, b: 2}
                    });*/
                    wx.navigateBack();
                }, function (res) {
                    let errorMsg = utils.getErrorMsg(res);
                    wx.showModal({title: '报名失败', content: errorMsg.title + '；' + errorMsg.content})
                }, function (res) {
                    console.log(res)
                });
        }
    }
    ,
    helpApply: function (e) {//帮人报名
        wx.des
        app.wxService.navigateTo("activity/helpenlist/helpenlist")
    }
})