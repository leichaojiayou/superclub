const app = getApp();
const actApi = app.api("actApi");
const userApi = app.api("userApi");
const utils = app.util
const session = app.session;

let inputData = new Object();
/**
 是否重定向到applylist页面
 */
let redirectPage = false;
let applyInfos;
let applyResult = 0;
let activityId, applyId;//活动ID、报名Id
Page({
    data: {
        type: 0,//0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式；3、帮报名填写模式（需要重定向到applylist页）
        isCost: false,
        selectTicketIndex: 0,
        selectTicket: {}, //已选择的票价
        tickets: [], //票价列表
        fields: [], //需要填写的信息列表

        //验证手机的字段
        authCode: "",
        interval: "",
        authDialog: {
            phone: '',
            modalShowStyle: "",
            focus: false,
            status: 0, //0: 显示发送验证码的按钮 1: 倒数中
        },
        countDown: 30,
    },
    ticketSelect: function (e) {//费用选择器
        this.setData({
            selectTicketIndex: e.detail.value,
            selectTicket: this.data.tickets[e.detail.value],
        })
    },
    pickerEvent: function (e) {//选择器事件
        let that = this;
        let index = e.currentTarget.dataset.index;
        let item = e.currentTarget.dataset.item;
        that.data.fields[index].select = e.detail.value;
        that.data.fields[index].defaultValue = item.option[e.detail.value];
        this.setData({
            fields: that.data.fields,
        });
        inputData[item.fieldName] = item.option[e.detail.value];
        console.log(inputData, e);
    },
    inputEvent: function (e) {//输入框事件
        let index = e.currentTarget.dataset.index;
        let item = e.currentTarget.dataset.item;

        inputData[item.fieldName] = e.detail.value;
        this.data.fields[index].defaultValue = e.detail.value;
        console.log(inputData);
    },
    /**
     * type :0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式
     * @param param{type:0,activityId:123}
     */
    onLoad: function (param) {
        //初始化全局变量
        redirectPage = false;
        applyResult = 0;
        activityId = 0;
        applyId = 0;
        let that = this;
        activityId = param.activityId;
        if (param.type == 3) {
            redirectPage = true;
            that.setData({
                type: 1
            });
        } else {
            that.setData({
                type: param.type
            });
        }
        if (that.data.type == 0) {
            app.wxService.setNavigationBarTitle("报名活动");
            that.loadApplyInfo();
        } else if (that.data.type == 1) {
            app.wxService.setNavigationBarTitle("帮人报名");
            applyInfos = session.getApplyInfo();
            if (!applyInfos) {
                applyInfos = {current: 0, infos: []};
                that.loadApplyInfo();
            } else if (!applyInfos.infos) {
                applyInfos = {current: 0, infos: []};
                that.loadApplyInfo();
            } else {//帮人报名编辑模式
                let applyInfo = applyInfos.infos[applyInfos.current];
                console.log(applyInfo);
                if (applyInfo) {
                    that.setData({
                        isCost: applyInfo.isCost,
                        selectTicketIndex: applyInfo.selectTicketIndex,
                        selectTicket: applyInfo.selectTicket,//已选择的票价
                        tickets: applyInfo.tickets,//票价列表
                        fields: applyInfo.fields,//需要填写的信息列表
                    });
                } else {
                    that.loadApplyInfo();
                }
            }
        } else if (that.data.type == 2) {
            app.wxService.setNavigationBarTitle("修改报名资料");
            applyId = param.applyId;
            that.loadApplyInfo();
        }
    },
    loadApplyInfo: function () {//获取报名需要填写的信息
        let that = this;
        actApi.getApplyInfo({
            data: {
                activity_id: activityId,
                apply_id: applyId,
            },
        }, function (res) {
            console.log(JSON.stringify(res.data));
            let data = res.data;
            let fields = res.data.fields;
            let actForm = JSON.parse(res.data.actForm);
            let tickets = res.data.tickets;
            let fieldArr = actForm.map(function (item) {
                return item.name;
            });
            fields.filter(function (element, index, self) {//用于过滤出真实需要填写的数据
                console.log(element); // 依次打印'A', 'B', 'C'
                console.log(index); // 依次打印0, 1, 2
                console.log(self); // self就是变量arr
                if (fieldArr.indexOf(element.fieldName) < 0) {
                    return false;
                } else {
                    return true;
                }
            });
            fields.forEach(function (item) {
                if (item.fieldType == 2 && item.option) {//选择
                    item.option = item.option.split(',');
                    if (!item.defaultValue) {
                        item.defaultValue = item.option[0];
                    }
                    item.select = item.option.indexOf(item.defaultValue);
                    inputData[item.fieldName] = item.option[0];
                } else {//文本填写
                    if (that.data.type == 2) {
                        inputData[item.fieldName] = item.defaultValue;
                    } else {
                        inputData[item.fieldName] = null;
                    }
                    if (item.fieldName == "手机") {
                        item.inputType = "number";
                        item.placeHolder = "请填写手机";
                        item.maxText = 11;
                        if (data.mobile && that.data.type == 0) {
                            item.defaultValue = data.mobile;
                            inputData[item.fieldName] = item.defaultValue;
                        }
                    } else {
                        item.inputType = "text";
                        item.maxText = 30;
                    }
                    if (item.fieldName == "昵称") {
                        item.placeHolder = "请填写昵称";
                        item.maxText = 10;
                        if (data.userNick && that.data.type == 0) {
                            item.defaultValue = data.userNick;
                            inputData[item.fieldName] = item.defaultValue;
                        }
                    }
                }
            });

            if (tickets && tickets.length != 0) {//付费活动
                let tickets = res.data.tickets;
                let selectTicket = data.tickets[0];
                tickets.forEach(function (item) {
                    item.desc = item.name + "：" + (item.cost / 100);
                });
                that.setData({
                    isCost: true,
                    fields: data.fields,
                    selectTicketIndex: 0,
                    selectTicket: selectTicket,
                    tickets: tickets,
                });
            } else {//免费活动
                that.setData({
                    isCost: false,
                    fields: data.fields,
                });
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '报名信息加载失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(res)
        });
    },
    checkInput: function (showTips) {//检查填写信息是否有错误
        for (let item of this.data.fields) {
            let value = inputData[item.fieldName];
            if ((!value || value.lengh == 0)) {
                if (showTips) {
                    app.wxService.showModal({title: "报名信息填写错误", content: item.fieldName + "为空"});
                }
                return false;
            }
        }
        return true;
    },
    greenButton: function () {//立即报名、或”保存“按钮
        //type: 0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式
        let that = this;
        if (that.data.type == 0) {//立即报名
            that.apply();
        } else if (that.data.type == 1) {//保存按钮，帮报名,将数据存入stroage，并重定向到applylist
            if (this.checkInput(true)) {
                let applyInfo = {
                    isCost: that.data.isCost,
                    selectTicketIndex: that.data.selectTicketIndex,
                    selectTicket: that.data.selectTicket,//已选择的票价
                    tickets: that.data.tickets,//票价列表
                    fields: that.data.fields,//需要填写的信息列表
                };
                applyInfos.infos[applyInfos.current] = applyInfo;
                session.saveApplyInfo(applyInfos);
                if (redirectPage) {
                    let url = "activity/applylist/applylist?type=1&isCost=" + that.data.isCost + "&activityId=" + activityId;
                    app.wxService.redirectTo(url);
                } else {
                    app.wxService.navigateBack();
                }
            }
        } else if (this.data.type == 2) {//修改报名资料
            that.update();
        }
    },
    update: function () {//修改报名资料
        let that = this;
        let data = JSON.stringify(inputData);
        console.log(data);
        if (this.checkInput(true)) {
            actApi.updateApplyInfo({
                    data: {
                        actID: activityId,
                        data: data,
                        ticketID: that.data.selectTicket.ticketID,
                        phone: inputData["手机"],
                        applyPlatform: 3,
                        applyID: applyId,
                    },
                    method: "POST",
                }
                , function (res) {
                    let pages = getCurrentPages();
                    let currPage = pages[pages.length - 1];   //当前页面
                    let prevPage = pages[pages.length - 2];  //上一个页面
                    prevPage.recvData(5);
                    app.wxService.navigateBack();
                }, function (res) {
                    let errorMsg = utils.getErrorMsg(res);
                    app.wxService.showModal({title: '保存失败', content: errorMsg.title + '；' + errorMsg.content})
                }, function (res) {
                    console.log(res)
                });
        }
    },
    apply: function () { //立即报名
        let that = this;
        let data = JSON.stringify(inputData);
        console.log(data);
        if (!this.checkInput(false)) {
            getApp().wxService.showToast("报名信息有误");
            return
        } else if (getApp().session.isTempUser()) {
            this.validatePhone();
            return
        }

        actApi.actApplySelf({
            data: {
                activity_id: activityId,
                data: data,
                ticket_id: that.data.selectTicket.ticketID,
                phone: inputData["手机"],
                paid: 0,
                applyPlatform: 3,
            },
            method: "POST",
        }, function (res) {
            app.wxService.showToast("报名成功");
            applyResult = res.data.result;
            if (applyResult > 0) { //报名成功，返回活动详情页面，并带回值
                if (that.data.isCost) {
                    that.getUnPayId();
                } else {
                    let pages = getCurrentPages();
                    let currPage = pages[pages.length - 1];   //当前页面
                    let prevPage = pages[pages.length - 2];  //上一个页面
                    prevPage.recvData(applyResult);
                    app.event.emit(app.config.EVENT_APPLY_CHANGE, {actId: activityId, count: 1});
                    app.wxService.navigateBack();
                }
            } else { //报名失败
                // -1: 需要验证手机, 需要弹出验证码输入框.
                // -2: 手机验证码验证失败.
                // -3: 临时用户输入的手机号已关联了老用户.
                let error = ""; //报名错误信息
                switch (result) {
                    case -1:
                        error = '需要验证手机, 需要弹出验证码输入框.';
                        break;
                    case -2:
                        error = '手机验证码错误';
                        break;
                    case -3:
                        error = '手机号已关联了老用户';
                        break;
                }
                app.wxService.showModal({
                    title: '报名失败',
                    content: errorMsg.title + '；' + errorMsg.content
                })
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({
                title: '报名失败',
                content: errorMsg.title + '；' + errorMsg.content
            })
        }, function (res) {
            console.log(res)
        });
    },
    helpApply: function (e) { //帮人报名(立即报名页面点击帮人报名)
        let that = this;
        if (!this.checkInput(false)) {
            getApp().wxService.showToast("报名信息有误");
            return
        } else if (getApp().session.isTempUser()) {
            this.validatePhone();
            return
        }
        if (this.checkInput(false)) {
            let applyInfo = {
                isSelf: true,//是否自己的报名信息
                isCost: that.data.isCost,
                selectTicketIndex: that.data.selectTicketIndex,
                selectTicket: that.data.selectTicket,//已选择的票价
                tickets: that.data.tickets,//票价列表
                fields: that.data.fields,//需要填写的信息列表
            };
            applyInfos = {current: 1, infos: [applyInfo]};
            session.saveApplyInfo(applyInfos);
            redirectPage = true;
            that.setData({
                type: 1
            });
            app.wxService.setNavigationBarTitle("帮人报名");
            that.loadApplyInfo();
        } else {
            app.wxService.showModal({title: "报名信息填写错误", content: '请完善当前用户报名信息'});
        }
    },

    /**
     * 微信小程序临时用户，验证手机号码
     */
    validatePhone: function () {
        let phone = inputData["手机"]
        let that = this;
        userApi.sendAuthCode({
            data: {
                auth_type: 2,
                phone: phone
            }
        }, res => {
            let interval = setInterval(() => {
                let leftTime = that.data.countDown - 1;
                let authDialog = that.data.authDialog
                if (leftTime > 0) {
                    that.setData({
                        countDown: leftTime
                    })
                } else {
                    clearInterval(interval)
                    authDialog.status = 0
                    that.setData({
                        authDialog: authDialog,
                        countDown: 30
                    })
                }
            }, 1000)
            let authDialog = that.data.authDialog
            authDialog.phone = phone
            authDialog.status = 1
            authDialog.focus = true
            authDialog.modalShowStyle = "opacity:1;pointer-events:auto;"
            that.setData({
                authDialog: authDialog,
                interval: interval,
                countDown: 30
            })
        }, res => {
            let errorData = app.util.getErrorMsg(res)
            let errorMsg = errorData.content
            if (errorMsg == '') {
                errorMsg = "发送验证码失败"
            }
            app.wxService.showToast(errorMsg)
        })
    },

    getAuthCode() {
        //点击发送验证码
        this.validatePhone()
    },

    authInput(e) {
        //输入验证码
        this.data.authCode = e.detail.value
    },

    touchCancel() {
        //点击取消
        clearInterval(this.data.interval)
        let authDialog = this.data.authDialog
        authDialog.modalShowStyle = ""
        authDialog.focus = false
        this.setData({
            authDialog: authDialog,
        })
    },

    touchAddNew() {
        let that = this
        if (this.data.authCode == '') {
            app.wxService.showToast('验证码不能为空')
            return
        }
        clearInterval(this.data.interval)
        //点击确定
        let authDialog = this.data.authDialog
        authDialog.modalShowStyle = ""
        authDialog.focus = false
        this.setData({
            authDialog: authDialog,
        })

        let code = this.data.authCode
        let phone = inputData["手机"]
        userApi.bindPhone({
            method: 'POST',
            data: {
                code: code,
                phone: phone,
            }
        }, res => {
            //绑定手机成功, 重新登录一下
            getApp().relogin(res => {
                that.apply()
            })
        }, res => {
            let errorData = app.util.getErrorMsg(res)
            let errorMsg = errorData.content
            if (errorMsg == '') {
                errorMsg = "绑定手机号码失败"
            }
            app.wxService.showToast(errorMsg)
        })
    },
    getUnPayId: function () {//报名成功,获取unPayID
        let that = this;
        actApi.getUnPayId({
            data: {
                activity_id: activityId,
            }
        }, function (res) {
            let unPayId = res.data.unPayId;
            if (unPayId > 0) {
                that.checkWeChatLogin(unPayId);
            } else {
                app.wxService.showModal({title: '支付订单ID错误', content: 'unPayId=' + unPayId})
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({//获取unPayId失败弹窗
                title: '获取支付订单错误',
                content: errorMsg.title + '；' + errorMsg.content,
                confirmText: "重试"
            }, function (res) {
                if (res.confirm) {//点击重试按钮，重试
                    that.getUnPayId();
                } else {//点击取消按钮，重载活动详情
                }
            })
        }, function (res) {
            console.log(res)
        });
    },
    checkWeChatLogin: function (unPayId) {//检查微信登录状态
        let that = this;
        wx.checkSession({
            success: function () {
                //登录态未过期
                that.payAction(unPayId);
            },
            fail: function () {
                //登录态过期
                app.relogin(function () {
                        that.payAction(unPayId);
                    },
                    function () {
                        app.wxService.showModal({title: '支付失败', content: '请授权微信登录'})
                    });
            }
        });
    },
    payAction: function (unPayId) {//支付操作，先从服务器获取支付必要信息，然后调用微信支付
        let that = this;
        actApi.pay({
            data: {
                order_id: unPayId,
            }
        }, function (res) {
            console.log(JSON.stringify(res.data));
            wx.requestPayment({
                timeStamp: "" + res.data.prepayParams.timestamp,
                nonceStr: "" + res.data.prepayParams.nonceStr,
                package: 'prepay_id=' + res.data.prepayParams.prepayID,
                signType: 'MD5',
                paySign: res.data.prepayParams.sign,
                success: function (res) {//微信返回的支付成功
                    console.debug(res);
                    let pages = getCurrentPages();
                    let currPage = pages[pages.length - 1];   //当前页面
                    let prevPage = pages[pages.length - 2];  //上一个页面
                    prevPage.recvData(applyResult);
                    app.event.emit(app.config.EVENT_APPLY_CHANGE, {actId: activityId, count: 1});
                    app.wxService.navigateBack();
                },
                fail: function () {
                    app.wxService.showToast("微信支付失败", 2000);
                    let pages = getCurrentPages();
                    let currPage = pages[pages.length - 1];   //当前页面
                    let prevPage = pages[pages.length - 2];  //上一个页面
                    prevPage.recvData(110);//返回act_detail result==110，代表支付失败
                    app.wxService.navigateBack();
                },
                complete: function () {
                }
            })
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '获取支付信息失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(res);
        });
    },
});