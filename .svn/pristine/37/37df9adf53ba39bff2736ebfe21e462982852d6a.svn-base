/**
 * 报名详情就扣：http://doc.iweju.com/FitNesse.WejuBaHttp.ActivityDoc.ActivityApplyDetail
 */
const app = getApp();
const utils = app.util;
const actApi = app.api("actApi");
var applyId = 8376;
Page({
    data: {
        clubInfo: {},
        actInfo: {},
        applyInfo: {},

        cancelApplyAble: false,// 取消报名按状态 true 不可以点击颜色　false 可以点击颜色
        applyStatusIco: '',//报名状态图标
        applyStatusText: '',//报名状态描述
        actTitle: '',//活动标题
        host: '',//主办方
        actTime: '',//活动时间
        nickAndPhone: '',//昵称和和手机
        ticketName: '',//票名
        ticketCost: '',//票价
        qrCodeDesc: '',//电子票描述
        qrcode: '',
        /**
         * 详情类型
         * 1、报名成功-非帮报名
         * 2、报名成功-帮报名
         * 3、报名审核中
         * 4、待付款
         * 5、报名取消-超时未付款
         * 6、报名取消-主办方审核不通过
         * 7、报名取消-主办方拒绝
         * 8、报名取消-报名者取消
         */
        detailType: 0,

        hasPayInfo: false,//是否显示支付信息
        payCost: 0,//订单总价
        reduceCost: 0,//优惠
        needPayCost: 0,//实付金额
        orderNum: '',//订单编号
        payTime: '',//支付时间
        payWay: '',//支付方式
        orderId: '',//交易单号
        shoukuanAccount: ''//收款账户
    },
    onLoad: function (options) {
        let that = this;
        if (options) {
            applyId = options.applyId;
        }
        this.getApplyDetail();
    },
    /**
     * 收到上一个页面返回的数据
     * @param param {type:1} 1、修改报名信息成功刷新页面；
     */
    recvData: function (param) {
        let that = this;
        setTimeout(function () {
            if (param.type == 1) {
                that.getApplyDetail();
                app.wxService.showToast("修改成功");
            }
        }, 500);
    },
    getApplyDetail: function () {
        let that = this;
        actApi.applyDetail({
                data: {
                    applyID: applyId,
                }
            }, function (res) {
                console.log(JSON.stringify(res.data));
                let detailType = 0;
                let applyInfo = res.data.data.applyInfos[0];
                let actInfo = res.data.data.actInfo;
                let clubInfo = res.data.data.clubInfo;
                let orderInfo = res.data.data.orderInfo;
                let payee = res.data.data.payee;
                let cancelApplyAble = true;
                if (applyInfo.applyStatus == 1 && applyInfo.applyUserType == 0) {//自己报名成功
                    detailType = 1;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名成功';
                } else if (applyInfo.applyStatus == 1 && applyInfo.applyUserType == 1) {//帮人报名成功
                    detailType = 2;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名成功';
                    cancelApplyAble = false;
                } else if ((actInfo.howToPay == 2 && applyInfo.payStatus == 2 && applyInfo.applyStatus == 0)
                    || (actInfo.howToPay != 2 && applyInfo.applyStatus == 0)) {//待审核
                    detailType = 3;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名审核中';
                } else if (actInfo.howToPay == 2 && applyInfo.payStatus == 1) {//待付款
                    detailType = 4;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '待付款';
                } else if (actInfo.howToPay == 2 && applyInfo.payStatus == 6) {
                    detailType = 5;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名取消';
                } else if (applyInfo.applyStatus == 4) {//审核不通过
                    detailType = 6;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名取消';
                } else if (applyInfo.applyStatus == 3) {//主办方拒绝
                    detailType = 7;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名取消';
                } else if (applyInfo.applyStatus == 2) {//报名者取消
                    detailType = 8;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名取消';
                }
                that.setData({
                    clubInfo: clubInfo,
                    actInfo: actInfo,
                    applyInfo: applyInfo,
                    cancelApplyAble: cancelApplyAble,
                    detailType: detailType,
                    applyStatusIco: that.data.applyStatusIco,
                    applyStatusText: that.data.applyStatusText,
                    actTitle: actInfo.actTitle,
                    host: "主办方：" + clubInfo.clubTitle,
                    actTime: actInfo.activityTime,
                    nickAndPhone: applyInfo.userName + "-" + applyInfo.mobile,
                    ticketName: actInfo.howToPay == 2 ? applyInfo.ticketName : "免费体验票",
                    ticketCost: actInfo.howToPay == 2 ? "¥" + applyInfo.ticketCost / 100 : "免费",
                    hasPayInfo: actInfo.howToPay == 2 && applyInfo.payStatus == 2,//付费活动已付款，有支付信息
                    payCost: orderInfo.orderMoney / 100,
                    reduceCost: orderInfo.offersMoney / 100,
                    needPayCost: orderInfo.payMoney / 100,
                    orderNum: orderInfo.payNo,
                    payTime: utils.formatTime7(orderInfo.payTime),
                    payWay: orderInfo.payWayName,
                    orderId: orderInfo.orderID,
                    shoukuanAccount: payee.nick + "-" + payee.mobile,
                    qrcode: applyInfo.qrcode,
                });
            },
            function (res) {
                let errorMsg = utils.getErrorMsg(res);
                app.wxService.showModal({title: '报名详情加载失败', content: errorMsg.title + '；' + errorMsg.content})
            },
            function (res) {
                console.log(res)
            }
        );
    },
    goToActDetail: function (e) {
        app.wxService.navigateTo("activity/act_detail/act_detail", {
            clubID: this.data.clubInfo.clubID,
            activityID: this.data.actInfo.actID
        })
    },
    cancelApply: function (e) {//取消报名
        app.wxService.navigateTo('activity/applylist/applylist', {activityId: this.data.actInfo.actID, type: 0});
    },
    editApply: function (e) {//编辑报名
        app.wxService.navigateTo('activity/apply_page/apply_page', {
            activityId: this.data.actInfo.actID,
            applyId: this.data.applyInfo.applyID,
            type: 2,
        });
    },
    helpApply: function (e) {//帮人报名
        app.wxService.navigateTo('activity/applylist/applylist', {activityId: this.data.actInfo.actID, type: 1});
    },
    retryApply: function (e) {//重新报名
        app.wxService.navigateTo('activity/applylist/applylist', {activityId: this.data.actInfo.actID, type: 0});
    },
});