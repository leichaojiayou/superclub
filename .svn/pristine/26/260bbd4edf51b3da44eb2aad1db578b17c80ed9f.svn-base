
//index.js
//获取应用实例
var app = getApp()
Page({
  data: {
    clubs: [],
    statu: '1',
    myClub: {}
  },

  onLoad() {
    if (app.session.getUserKey() && app.session.getUserKey() != "") {
      //已经登录了。
      this.loadClubs()
      return
    }

    this.login()
  },

  login: function (userRes) {
    //调用微信登录，获取微信code
    let that = this
    wx.login({
      success: (res) => {
        if (res.code) {
          // 检查用户是否已经绑定超级俱乐部账号
          //https://mp.weixin.qq.com/debug/wxadoc/dev/api/open.html#wxgetuserinfoobject
          //获取微信用户信息, 获取encryptedData和iv
          wx.getUserInfo({
            success: (userRes) => {
              app.userApi.login({
                data: {
                  encryptedData: userRes.encryptedData,
                  iv: userRes.iv,
                  code: res.code
                }
              }, (res) => {
                that.validateBind(res)
              }, (res)=>{
                wx.showToast({title: 'cuowu'})
              })
            },
            fail: (res) => {
              console.log(res)
            }
          })
        }
      }
    });
  },

  validateBind: function (res) {
    let data = res.data;
    var that = this
    if (data.status != 1) {
      let errorCode = data.code;
      if (errorCode == 20001) {
        //未绑定手机号码
        wx.redirectTo({
          url: '../bind/bind'
        })
      }
    } else {
      //已经绑定了超级俱乐部账号ß
      app.session.saveUserInfo(data.user, data._key)
      that.loadClubs();
    }
  },

  loadClubs: function () {
    //请求我加入的俱乐部列表
    let that = this
    getApp().userApi.myClubs({}, (res) => {
      let status = 1
      let clubName = ""
      let data = res.data;
      let clubList = data.clubs;
      let len = clubList.length;
      let clubs = []
      for (var i = 0; i < len; i++) {
        let club = clubList[i];
        if (club.status == 0) {
          //俱乐部创建审核中
          status = 2
          clubName = club.title
          that.setData({
            myClub: club
          })
        } else if (club.roleType >= 2) {
          //担任管理级别
          status = 3
          clubName = club.title
          that.setData({
            myClub: club
          })
        } else {
          clubs.push(club)
        }
      }

      that.setData({
        //渲染UI
        statu: status,
        clubname: clubName,
        clubs: clubs
      })
    })
  },

  manageClub: function (e) {
    let myClub = this.data.myClub;
    let status = this.data.statu;
    if (status == 1) {
      //创建俱乐部
      wx.navigateTo({
        url: '../cjjlb/cjjlb'
      })
    } else if (status == 2) {
      //俱乐部审核中
    } else if (status == 3) {
      //进入管理页面
      wx.navigateTo({
        url: "../gljlb/gljlb?clubId=" + myClub.clubID
      })
    }
  },

  clubHome: function (e) {
    let clubId = e.currentTarget.dataset.id
    wx.navigateTo({
      url: '../../club/clubhome/clubhome?clubId=' + clubId,
    })
  },
})