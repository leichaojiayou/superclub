// pages/create_club/create_club.js
var app = getApp()
var clubApi = app.api("clubApi")

Page({
  data: {
    choose: 'è¯·é€‰æ‹©',
    input: 'è¾“å…¥',
    txt: 'å†™ä¸€æ®µç®€ä»‹æè¿°ä½ çš„ä¿±ä¹éƒ¨å§',

    logo: "",
    remoteLogo: "",
    name: "",
    location: "",
    cityId: "",
    setupTime: "",
    feature: "",
    slogan: "",
    desc: "",
    charger: "",
    phone: ""
  },

  //ä¿±ä¹éƒ¨logo
  clickLogo() {
    let that = this
    wx.chooseImage({
      count: 1, // é»˜è®¤9
      sizeType: ['compressed'], // å¯ä»¥æŒ‡å®šæ˜¯åŸå›¾è¿˜æ˜¯å‹ç¼©å›¾ï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
      sourceType: ['album', 'camera'], // å¯ä»¥æŒ‡å®šæ¥æºæ˜¯ç›¸å†Œè¿˜æ˜¯ç›¸æœºï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
      success: function (res) {
        // è¿”å›é€‰å®šç…§ç‰‡çš„æœ¬åœ°æ–‡ä»¶è·¯å¾„åˆ—è¡¨ï¼ŒtempFilePathå¯ä»¥ä½œä¸ºimgæ ‡ç­¾çš„srcå±æ€§æ˜¾ç¤ºå›¾ç‰‡
        var tempFilePaths = res.tempFilePaths
        that.setData({
          logo: tempFilePaths[0]
        })
      }
    })
  },

  //ä¿±ä¹éƒ¨åç§°
  clickName() {
    app.wxService("club/modify/clubName/clubName")
  },

  //æ‰€åœ¨åœ°
  clickLocation() {
    app.wxService("club/modify/")
  },

  //åˆ›ç«‹æ—¶é—´
  clickSetupTime() {
    //app.wxService("club/modify/")
  },

  //ä¸»æ‰“é¡¹ç›®
  clickFeature() {
    app.wxService("club/modify/masterProjects/masterProjects")
  },

  //å®£è¨€
  clickSlogan() {
    app.wxService("club/modify/declaretion/declaretion")
  },

  //ç®€ä»‹
  clickDesc() {
    app.wxService("club/modify/description/description")
  },
  //è´Ÿè´£äºº
  inputCharger(e) {
    this.data.charger = e.detail.value
  },
  //è”ç³»æ–¹å¼
  inputPhone(e) {
    this.data.phone = e.detail.value
  },

  validate() {
    //æ ¡éªŒé€šè¿‡
    return true
  },

  createClub() {
    if (app.session.isTempUser()) {
      //ä¸´æ—¶ç”¨æˆ·ï¼Œéœ€è¦å…ˆç»‘å®šæ‰‹æœº
      return
    }

    if (this.validate() == false) {
      //ç¼ºå°‘å¿…å¡«é¡¹
      return
    }
    const data = this.data

    //todo remove test data 
    let testlogo = "https://cdn.51julebu.com/club/img/170212/c00135e941674ea79901a4c86f15f200.jpg"
    data.remoteLogo = testlogo
    data.name = "å°ç¨‹åºä¿±ä¹éƒ¨è€Œ"
    data.logo = data.remoteLogo
    data.desc = "å“ˆå“ˆå“ˆ"
    data.slogan = "è¿™æ˜¯æ˜¯å’¯å…±"
    data.cityId = "351"
    data.need_join_check = "0"
    data.charger = "æ¸©å˜‰è¾‰"
    data.phone = "15692004550"
    data.feature = '1001'

    if (data.remoteLogo === '') {
      //å…ˆä¸Šä¼ logoåˆ°æœåŠ¡å™¨
      uploadLogo()
      return
    }

    clubApi.createClub({
        method: 'POST',
        data: {
          title: data.name,
          logo: data.remoteLogo,
          description: data.desc,
          slogan: data.slogan,
          city_id: data.cityId,
          need_join_check: "0",
          contact_name: data.charger,
          contact_tel: data.phone,
          feature: data.feature
        }
      }, res => {
        //æˆåŠŸ
        app.wxService.showModal({
          title: "åˆ›å»ºç”³è¯·å·²æäº¤",
          content: "ç”³è¯·å·²æäº¤ï¼Œå·¥ä½œäººå‘˜å°†åœ¨3ä¸ªå·¥ä½œæ—¥å†…è”ç³»æ‚¨ï¼Œè¯·è€å¿ƒç­‰å€™å¹¶ä¿æŒç”µè¯ç•…é€š",
          showCancel: false,
        }, res => {
          if (res.confirm) {
            app.wxService.navigateBack(1)
          }
        })
      },
      res => {
        //å¤±è´¥
        let errorData = app.util.getErrorMsg(res)
        app.wxService.showToast(errorData.title + "," + errorData.content)
      })
  },

  uploadLogo() {
    let localPath = this.data.logo
    wx.uploadFile({
      url: 'http://example.weixin.qq.com/upload', //ä»…ä¸ºç¤ºä¾‹ï¼ŒéçœŸå®çš„æ¥å£åœ°å€
      filePath: tempFilePaths[0],
      name: 'file',
      formData: {
        'user': 'test'
      },
      success: function (res) {
        var data = res.data
      }
    })
  }
})