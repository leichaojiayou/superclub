const app = getApp()
const systemApi = app.api("systemApi")
const clubApi = app.api("clubApi")

Page({
  data: {
    clubMsgs: [{
      user: {
        avatar: "https://o42nhyss1.qnssl.com/club/img/160723165022/8a5318c360b74326bb0887a0c6acc94a.jpeg",
        nick: "dddddddd",
        medal: "",
        userID: 12241
      },
      club: {
        clubID: 100404,
        title: "一起嗨"
      },
      joinInfo: "我想加入你们的俱乐部",
      joinStatus: -1, // 0 自动加入  -1 申请加入  1 已通过   2 已拒绝   5 退出俱乐部
      createTime: 1485070397000,
      time: '01-21 13:00',
    }],

    // item里面的状态
    actMsgs: [{
      msgid: 486640454671855740,
      createtime: 1486640454671,
      time: '12-23 12:45',
      type: 1,
      content: {
        actID: 591707,
        image: "https://o42nhyss1.qnssl.com/club/img/161223215720/c555cccb054b4ae1b1212961ae8a9159.jpg",
        title: "个xxxxx",
        content: "好纠结付费修改了报名"
      }
    }],
    click_onActivity: true,
    hasLoadActs: false,
    hasLoadClubs: false,
    clubId: 0,
  },

  onLoad: function (options) {
    let clubId = options.clubId
    this.data.clubId = clubId
    let unreadCount = options.num
    if (unreadCount > 0) {
      //俱乐部管理消息大于0，直接定位到俱乐部消息tab页
      this.setData({
        click_onActivity: false,
      });
      this.data.hasLoadClubs = true
      this.loadClubMsgs()
    } else {
      this.data.hasLoadActs = true
      this.loadActs()
    }
  },

  loadActs: function () {
    let that = this
    systemApi.loadActMsg(this.data.clubId, res => {
      let messages = res.data.result.filter(e => {
        return e.type == 1
      }).forEach(e => {
        e.time = app.util.formatTime2(e.createtime)
      })
      that.setData({
        actMsgs: messages
      })
    }, res => {

    })
  },

  loadClubMsgs() {
    let that = this
    let clubId = this.data.clubId
    clubApi.clubMemberJoinMessages({
      data: {
        club_id: clubId
      }
    }, (res) => {
      let data = res.data
      let messages = data.joins;
      messages.forEach((element) => {
        element.time = app.util.formatTime2(element.createTime)
      })
      that.setData({
        clubMsgs: messages
      })
    }, res => {

    })
  },

  bindButton(e) {
    let obj = e.target.dataset;
    let click = obj.id;
    if (click == 'onActivity') {
      this.setData({
        click_onActivity: true,
      });
      if (!this.data.hasLoadActs) {
        //实现懒加载
        this.data.hasLoadActs = true
        this.loadActs()
      }
    } else if (click == 'onClub') {
      this.setData({
        click_onActivity: false,
      });
      if (!this.data.hasLoadClubs) {
        //实现懒加载
        this.data.hasLoadClubs = true
        this.loadClubMsgs()
      }
    }
  },

  //同意
  bindApprove(e) {
    const info = e.currentTarget.dataset.info
    this.handleJoin(info, true)
  },

  //拒绝
  bindRefuse(e) {
    let info = e.currentTarget.dataset.info
    this.handleJoin(info, false)
  },

  handleJoin(info, approve) {
    let that = this
    clubApi.verfiyClubMemberJoin({
      data: {
        club_id: info.club.clubID,
        user_id: info.user.userID,
        flag: approve ? 1 : -1
      }
    }, (res) => {
      //操作成功，将消息移除
      let messages = that.data.clubMsgs
      for (var i = 0; i < messages.length; i++) {
        let msg = messages[i];
        if (msg.createTime == info.createTime) {
          msg.joinStatus == approve ? 1 : 2
        }
      }

      //更新上一个页面的未读数
      let pages = getCurrentPages()
      let prevPage = pages[pages.length - 2]
      let unreadCount = prevPage.data.club.joinUnCheckNum - 1
      if (unreadCount < 0) unreadCount = 0
      prevPage.setData({
        club: {
          joinUnCheckNum: unreadCount
        }
      })

      that.setData({
        clubMsgs: messages
      })
    })
  }
})