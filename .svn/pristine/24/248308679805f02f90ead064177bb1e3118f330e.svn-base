//index.js
//获取应用实例
const App = getApp();
const clubApi = App.api('clubApi');
const wxService = App.wxService
Page({
  data: {
    items: [
      {
        "name": "徒步",
        "id": 1
      },
      {
        "name": "跑步",
        "id": 2
      },
      {
        "name": "骑行",
        "id": 3
      },
      {
        "name": "登山",
        "id": 4
      },
      {
        "name": "野营",
        "id": 5
      },
      {
        "name": "钓鱼",
        "id": 6
      },
      {
        "name": "球类",
        "id": 7
      },
      {
        "name": "摄影",
        "id": 8
      },
      {
        "name": "潜水",
        "id": 9
      },
      {
        "name": "自驾",
        "id": 10
      }
    ]
  },
  //copy object
  __copyObj: function (obj) {
    let copy = {}
    if (typeof obj === 'object') {
      copy = JSON.parse(JSON.stringify(obj))
    }
    return copy;
  },

  __judge: function () {
    let items = this.data.items, i = 0, count = 0;
    for (; i < items.length; i++) {
      if (items[i].isOn == true) {
        count++;
      }
    }
    return count;
  },

  onLoad: function (e) {
    if (!e.type) {
      const that = this;
      let param = { data: {} };
      param.data.club_id = this.data.clubID;
      clubApi.masterProjects(param, res => {
        console.log(res);
        let items = res.data.data, i = 0, j = 0, features = e.features.split(',');
        wx.setStorageSync('masterProject', items);
        for (let k = 0; k < items.length; k++) {
          items[k].isOn = false;
        }
        for (; i < features.length; i++) {
          for (; j < items.length; j++) {
            if (features[i] === items[j].name) {
              items[j].isOn = true;
              break;
            }
          }
        }
        this.setData({
          items: items,
          clubID: e.clubID,
          type: e.type
        })
      })
    } else {
      this.data.type = e.type
    }
  },

  selectProject: function (e) {
    let items = this.data.items, i = 0, count = 0, index = e.currentTarget.dataset.index - 1;
    const itemz = this.__copyObj(this.data)
    items[index].isOn = !items[index].isOn
    count = this.__judge();
    if (count > 3) {
      App.util.showTip(this, '最多选择3个主打项目!')
      this.setData({
        items: itemz.items
      })
    } else {
      this.setData({
        items: items
      })
    }
  },

  submit: function () {
    let param = this.__spellFeatures().get('param'), tempFeatures = this.__spellFeatures().get('tempFeatures');
    if (!this.data.type) {
      clubApi.modifyClub(param, res => {
        if (res.data.status === 1) {
          App.event.trigger('club', {
            features: tempFeatures
          })
          App.event.trigger('clubHome', {
            features: tempFeatures
          })
          wxService.navigateBack();
        }
      })
    }
  },

  onUnload: function () {
    let tempFeatures = this.__spellFeatures().get('tempFeatures');
    App.event.trigger('club_fill', {
      features: tempFeatures
    }, {}, true);
  },

  __spellFeatures: function () {
    let count = this.__judge(), projects = [], items = this.data.items, i = 0, param = { data: {} },map = new Map(),
    tempFeatures = [];
    if (count < 4) {
      for (; i < items.length; i++) {
        if (items[i].isOn == true) {
          projects.push(items[i].id);
          tempFeatures.push({
            id: items[i].id,
            name: items[i].name
          })
        }
      }
    }
    param.data.club_id = this.data.clubID;
    param.data.features = projects.join(',') || '0,0,0'
    map.set('param', param);
    map.set('tempFeatures', tempFeatures);
    return map
  }



})
