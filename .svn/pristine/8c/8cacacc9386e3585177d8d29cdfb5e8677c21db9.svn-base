//活动详情页面
const app = getApp();

//测试数据
var activityId = 591623;
var clubId = 100315;
const loadCount = 10;//一次加载的数目
let applyStart = '', commentStart = '', applyMore = 0, commentMore = 0;//报名列表、评论列表请求start，报名、评论列表是否还能加载更多
Page({
    data: {
        activityEntity: {},//活动详情实体
        cover: '',//活动封面
        actTitle: '',//活动标题
        publishMan: '',//发布者昵称
        createTime: '',//发布时间
        deadlineTime: '',//报名截止时间
        readNum: '',//阅读量
        shareNum: '',//分享量
        actAddress: '',//活动地点描述
        hideActAddress: false,//没有设置地点时隐藏
        actTime: '',//活动时间（2014.1.1-2014.2.2）
        actCost: '',//活动费用（¥150～¥300）
        hideActCost: false,//免费活动隐藏票价选项
        host: '',//举办方（广州市花都区户外运动俱乐部）
        hideHost: '',//是否显示举办方
        contents: [],//活动内容
        hideApplyLoadMore: false,//是否隐藏加载更多报名列表按钮
        applyed: [],//报名列表
        hideCommentLoadMore:false,//是否隐藏加载更多评论列表按钮
        comments:[],//评论列表
        status: 0,
    },
    changecolor: function (e) {//切换tab操作
        let id = e.target.id;
        this.setData({
            status: id
        })
        console.log(this.data.status);
    },
    changebtn: function (e) {
        wx.showActionSheet({
            itemList: ['帮人报名', '取消报名', '修改资料'],
            success: function (res) {
                console.log(res.tapIndex)
                if (res.tapIndex == 0) {
                    app.wxService.navigateTo('../apply_page/apply_page');
                }
            }
        })
    },
    viewActAddress: function () {//查看活动地图位置
        let latitude = this.data.activityEntity.latInt / 1000000;
        let longitude = this.data.activityEntity.lngInt / 1000000;
        console.log(latitude + "aaaaaaaa" + longitude);
        wx.openLocation({latitude: latitude, longitude: longitude})
    },

    loadApplyList: function () {//加载报名列表列表请求
        let that = this;
        app.actApi.getActApplyList({
            data: {
                activity_id: activityId,
                start: applyStart,
                count: loadCount,
            }
        }, function (res) {
            let applyList = res.data.applyList;
            applyStart = res.data.start;
            applyMore = res.data.more;
            applyList.forEach(function (element) {
                element.applyTime = app.util.formatTime3(element.applyTime);
            });
            that.setData({
                applyed: applyList,
                hideApplyLoadMore: applyMore == 1,
            });
            console.log("---------报名列表数据---------\n", that.data.applyed)
            console.info(JSON.stringify(res.data));
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            wx.showModal({title: '报名列表加载失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(res)
        });
    },
    loadingMoreApply: function () {//点击加载更多报名人
        this.loadApplyList();
    },
    loadComment: function () {//加载评论列表
        let that = this;
        app.actApi.getActComment({
            data: {
                activity_id: activityId,
                start: commentStart,
                count: loadCount,
            }
        }, function (res) {
            let commentList = res.data.commentList;
            commentStart = res.data.start;
            commentMore = res.data.more;
            commentList.forEach(function (element) {
                element.postTime = app.util.formatTime3(element.postTime);
            });
            that.setData({
                comments: commentList,
                hideCommentLoadMore: applyMore == 1,
            });
            console.log("----------评论列表数据--------\n", that.data.comments)
            console.info(JSON.stringify(res.data));
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            wx.showModal({title: '报名列表加载失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(res)
        });
    },
    loadingMoreComment: function () {//点击加载更多报名人
        this.loadComment();
    },
    onLoad: function () {
        wx.setNavigationBarTitle({
            title: '活动详情'
        });
        console.log(app, app.wxService.actApi);
        let that = this;
        app.actApi.getActDetail({//活动详情请求
                data: {
                    activity_id: activityId,
                    club_id: clubId
                },
            },
            function (res) {//成功回调
                let data = res.data.activityEntity;
                that.setData({
                    activityEntity: data,
                    cover: data.cover,
                    actTitle: data.title,
                    publishMan: data.actUserNick,
                    createTime: app.util.formatTime3(data.createTime) + '发布',
                    deadlineTime: "报名截止时间 " + app.util.formatTime4(data.deadlineTime),
                    readNum: '阅读' + data.readNum,
                    shareNum: '分享' + data.shareNum,
                    actAddress: data.actAddress,
                    hideActAddress: data.lngInt != 0 && data.latInt != 0,//经纬度都为0则是没有设置地址
                    actTime: app.util.formatTime3(data.beginTime) + '-' + app.util.formatTime3(data.endTime),
                    actCost: '¥' + data.cost,
                    hideActCost: data.howToPay != 1,//免费活动不显示 费用内容
                    publishClub: data.clubName,
                    hideHost: data.clubId != 0,
                    contents: data.contents,
                })
                console.info(JSON.stringify(res.data))
            },
            function (res) {//失败回调
                let errorMsg = utils.getErrorMsg(res);
                wx.showModal({title: '活动详情加载失败', content: errorMsg.title + '；' + errorMsg.content})
            });

        that.loadApplyList();
        that.loadComment();
    }
})