// pages/edit/edit.js
Page({
  data: {
    status:2,
    // array index bindPickerChange是支付状态选择相关数据
    array: ['待付款，设为已付款', '已付款'],
     index: 0,
    //  array1 index1 bindPickerChange1是骑行服选择相关数据
    array1: ['选手骑行服xs', '选手骑行服s','选手骑行服m'],
    index1: 0,
    //  array2 index2 bindPickerChange2是分组选择相关数据
    array2: ['未分组', '第一组','第二组'],
    index2: 0,

    rightarrow:'../images/right-errow.png',
    item:
    { t1: '票价', price: '￥270', t2: '潜水22人组票价的名字可以有这么' },

    activityID:0,
    applyID:0,
    nick:'',
    applyFields:[],
    checkStatus:'',//拒绝，取消,无
    hiddenAlert:true,
    reason:'',
    howToPay:1,
    ticketPrice:'￥0.0',
    ticketName:'',
    itemArray:[],//第二组
    payArray:[],//第三组
    fieldGroup:{},//第四组
  },

  onLoad:function(options){
  
    this.setData({
      activityID:options.activityID,
      applyID:options.applyID,
      nick:options.nick,
      howToPay:options.howToPay,
    })
    this.reqeustGetApplyInfo(options.activityID,options.applyID)
  },

  tapRefuseButton:function(e){
    //弹窗
    var that = this
    var checkStatus = this.data.checkStatus
    if(checkStatus == '拒绝'){
      //弹出输入框
      this.setData({
        hiddenAlert:false,
      })

    }else{
      //弹提示
      var title = '确定取消"'+this.data.nick+'"的报名吗？Ta将不能再报名本次活动'
      wx.showModal({
        title: title,
        content: '',
        success: function(res) {
          if (res.confirm) {
            that.reqeustRefuseApply('')
          }
        }
      })
    }
  },
  tapCancelAlert:function(e){
    this.setData({
      hiddenAlert:true,
    })
  },
  tapSureAlert:function(e){
    this.setData({
      hiddenAlert:true,
    })
    this.reqeustRefuseApply(this.data.reason)
    
   },
  didInputChanged:function(event){
    this.data.reason = event.detail.value
    console.log(event.detail.value)
  },
  //报名选项内容改变了
  didFieldTextChanged:function(e){
    var index = e.currentTarget.id
    var itemArray = this.data.itemArray
    var item = itemArray[index]
    item.currentValue = e.detail.value
  },
  //分组：改变了
  didGroupNameChanged:function(e){
    var index = e.detail.value
    var fieldGroup = this.data.fieldGroup
    fieldGroup.currentValue = fieldGroup.ranges[index]
    this.setData({
      fieldGroup:fieldGroup,
    })
  },
  didItemPickerChanged:function(e){
    var itemIndex = e.currentTarget.id
    var index = e.detail.value
    var itemArray = this.data.itemArray
    var item = itemArray[itemIndex]
    item.currentValue = item.ranges[index]
    this.setData({
      itemArray:itemArray
    })
  },
  tapSaveButton:function(e){
    var object = new Object()
    var itemArray = this.data.itemArray
    for(var i=0;i<itemArray.length;i++){
      var item = itemArray[i]
      object[item.fieldName] = item.currentValue
    }

    object['分组'] = this.data.fieldGroup.currentValue

    var dictString = JSON.stringify(object);
    console.log(dictString)
    this.reqeustSaveApply(dictString)

  },

  handleApplys:function(applyFields){

    var itemArray = new Array()
    var payArray = new Array()
    var fieldGroup = {}
    var ticketName = ''
    var ticketPrice = ''
    for(var i=0;i<applyFields.length;i++){
        var item = applyFields[i]
        item.currentValue = item.defaultValue

        if(item.fieldType == 2){
          //带数组：第一组
          var ranges = item.option.split(",")
          item.ranges = ranges
          
          if(item.fieldName == '费用选择'){
            var arr = item.defaultValue.split("__")
            var nameAndPrice = arr[1]
            var arr2 = nameAndPrice.split("¥")
            ticketName = arr2[0]
            ticketPrice = '¥'+arr2[1]
            
          }else if(item.fieldName == '分组'){
            //第四组
            fieldGroup = item 
          }else{
            //第二组
            itemArray.push(item)
          }
          
        }else{
          //不带数组
          if(item.fieldName == '支付状态' || item.fieldName == '报名状态'){
            //第三组
            payArray.push(item)
          }else{
            //第二组
            itemArray.push(item)
          }
        }
    }

    console.log(payArray)

    this.setData({
      itemArray:itemArray,
      ticketName:ticketName,
      ticketPrice:ticketPrice,
      fieldGroup:fieldGroup,
      payArray:payArray,
    })
  },
 

  reqeustGetApplyInfo:function(data){
      
      var activityID = this.data.activityID
      var applyID = this.data.applyID
      var that = this
      getApp().api('manageApi').getEditApplyInfo({
          data:{
              activity_id:activityID,
              apply_id:applyID,
          }},
          function success(res){
              console.log('获取修改报名信息ok');

              console.log(res);
              var data = res.data
              var checkStatus = data.checkStatus
              if(!checkStatus || checkStatus == 'null' || checkStatus == 'NULL'){
                checkStatus = ''
              }
              
              that.setData({
                checkStatus:checkStatus,
              })
              that.handleApplys(data.applyFields)
          },
          function fail(res){
            console.log(res);
          },
      )
  },

  //拒绝
  reqeustRefuseApply:function(reason){
      
      var applyID = this.data.applyID
      var that = this
      getApp().api('manageApi').refusedApply({
          data:{
              reason:reason,
              apply_id:applyID,
          }},
          function success(res){
              console.log('拒绝报名成功');
              console.log(res);
              wx.navigateBack({
                  delta: 1, // 回退前 delta(默认为1) 页面
               })
          },
          function fail(res){
            console.log(res);
          },
      )
  },

  //保存 paid不用考虑
  reqeustSaveApply:function(dataString){
      
      var applyID = this.data.applyID
      var activityID = this.data.activityID
      var that = this
      getApp().api('manageApi').editApplyInfo({
          data:{
              activity_id:activityID,
              apply_id:applyID,
              data:dataString,
          }},
          function success(res){
              console.log('拒绝报名成功');
              console.log(res);
              wx.navigateBack({
                  delta: 1, // 回退前 delta(默认为1) 页面
               })
          },
          function fail(res){
            console.log(res);
          },
      )
  },
})