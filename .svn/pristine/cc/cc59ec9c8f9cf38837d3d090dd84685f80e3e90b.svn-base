/**
 * 支付页面
 * 待付订单详情接口：http://doc.iweju.com/FitNesse.WejuBaHttp.V222Doc.ActTest.MoneyOrderUnpayDetail222Doc
 */
const app = getApp();
const utils = app.util;
const actApi = app.api("actApi");

let unPayId = 17579;
let down = false;//是否可以开始倒计时
let authInput;
Page({
    data: {
        countDown: '29:00',//剩余时间
        activityName: '活动名称',
        startTime: '11月12日 12:00',//开始时间
        applyInfos: [],//报名信息
        sumUnpayMoney: '',//总报名费用
        sumNeedPayMoney: '0',//需要支付的费用
        voiceAuth: 1,// 是否验证过语音验证码 0未验证，1已验证
        voicePhone: '',//验证的手机号码
        voiceInfo: '',//验证弹窗的提示信息
        applyExpiredTime: 0,//报名剩余时间
        agreenstatu: false,//是否同意服务协议
        authDialog: {
            modalShowStyle: '',
            phone: '',//验证码接受手机号
            focus: false,//是否弹出软键盘
            countDown: 0,//倒计时秒数
            status: 0,//0、显示“发送验证码”，1、显示“重发30s”
            sendstatus: 1,//显示“注：下次报名将不再验证”
        },//验证手机弹窗
    },
    onLoad: function (options) {
        let that = this;
        if (options) {
            unPayId = options.unPayId;
        }
        actApi.getUnPayDetail({//获取付款详情
            data: {
                unpay_id: unPayId,
            }
        }, function (res) {
            console.log(JSON.stringify(res.data));
            let activity = res.data.unpay.unpayDetailInfo.activity;
            that.setData({
                activityName: activity.title,
                startTime: activity.beginTime,
                applyInfos: res.data.unpay.unpayDetailInfo.applyInfos,
                sumNeedPayMoney: res.data.unpay.sumNeedPayMoney,
                sumUnpayMoney: res.data.unpay.sumUnpayMoney,
                applyExpiredTime: res.data.applyExpiredTime,
            });
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '获取订单详情', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(res)
        })
    },

    hideAuthDialog() {
        this.setData({
            authDialog: {
                countDown: 0,
                modalShowStyle: '',
            }
        });
    },
    /**
     * 显示获取验证码弹窗
     * @param check 0、报名成功；1、待审核
     */
    showAuthDialog: function () {
        let that = this;
        this.setData({
            authDialog: {
                modalShowStyle: 'opacity:1;pointer-events:auto;',
                phone: that.data.voicePhone,//验证码接受手机号
                focus: true,//是否弹出软键盘
                countDown: 31,//倒计时秒数
                status: 0,//0、显示“发送验证码”，1、显示“重发30s”
                sendstatus: 0,//显示“注：下次报名将不再验证”
            }
        });
    },
    payAction: function () {//确认支付按钮
        let that = this;
        actApi.pay({
            data: {
                order_id: unPayId,
            }
        }, function (res) {
            console.log(JSON.stringify(res.data));
            that.goWechatPay(res);
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '获取支付信息失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(res);
        });
    },
    agreenbtn: function (e) {//同意服务协议
        this.setData({
            agreenstatu: !this.data.agreenstatu
        })
    },
    touchCancel: function () {//验证手机号弹窗 取消按钮
        this.hideAuthDialog();
    },
    touchAddNew: function () {//验证手机号弹窗 确定按钮

    },
    getAuthCode: function () {//发送验证码  按钮
        if (this.data.authDialog.countDown <= 0 || this.data.authDialog.countDown > 30) {
            this.startCountDown();
        }
    },
    startCountDown: function () {//开始倒计时循环
        let that = this;
        let countDown = that.data.authDialog.countDown - 1;
        console.log("--------倒计时--------", countDown);
        let status;
        if (countDown > 0) {
            status = 1;
        } else {
            status = 0;
        }
        if (countDown >= 0) {
            that.setData({
                authDialog: {
                    modalShowStyle: 'opacity:1;pointer-events:auto;',
                    phone: that.data.voicePhone,//验证码接受手机号
                    focus: false,//是否弹出软键盘
                    countDown: countDown,//倒计时秒数
                    status: status,//0、显示“发送验证码”，1、显示“重发30s”
                    sendstatus: 0,//显示“注：下次报名将不再验证”
                }
            });
        }
        if (that.data.authDialog.countDown > 0) {
            setTimeout(this.startCountDown, 1000);
        } else {
            that.data.authDialog.countDown = 31;
        }
    },
    goWechatPay: function (res) {//开始微信支付
        wx.requestPayment({
            timeStamp: "" + res.data.prepayParams.timestamp,
            nonceStr: "" + res.data.prepayParams.nonceStr,
            package: 'prepay_id=' + res.data.prepayParams.prepayID,
            signType: 'MD5',
            paySign: res.data.prepayParams.sign,
            success: function (res) {//微信返回的支付成功
                console.debug(res);
                let pages = getCurrentPages();
                let currPage = pages[pages.length - 1];   //当前页面
                let prevPage = pages[pages.length - 2];  //上一个页面
                prevPage.recvData(101);//返回act_detail result==101，代表支付成功
                app.wxService.navigateBack();
            },
            fail: function () {
                app.wxService.showToast("微信支付失败",2000)
            },
            complete: function () {
            }
        })
    }
})