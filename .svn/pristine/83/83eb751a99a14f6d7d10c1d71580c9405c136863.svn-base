/**
 * 报名详情就扣：http://doc.iweju.com/FitNesse.WejuBaHttp.ActivityDoc.ActivityApplyDetail
 */
const app = getApp();
const utils = app.util;
const actApi = app.api("actApi");
const session = app.session;
let applyId;
let applyResult = 0;
Page({
    data: {
        clubInfo: {},
        actInfo: {},
        applyInfo: {},

        costAct: false,//是否付费活动
        cancelApplyAble: false,// 取消报名按状态 true 不可以点击颜色　false 可以点击颜色
        applyStatusIco: '',//报名状态图标
        applyStatusText: '',//报名状态描述
        actTitle: '',//活动标题
        host: '',//主办方
        actTime: '',//活动时间
        nickAndPhone: '',//昵称和和手机
        ticketName: '',//票名
        ticketCost: '',//票价
        qrCodeDesc: '',//电子票描述
        qrcode: '',
        /**
         * 详情类型
         * 1、报名成功-非帮报名
         * 2、报名成功-帮报名
         * 3、报名审核中
         * 4、待付款
         * 5、报名取消-超时未付款
         * 6、报名取消-主办方审核不通过
         * 7、报名取消-主办方拒绝
         * 8、报名取消-报名者取消
         */
        detailType: 0,
        hasHelpApply: 0,//是否有帮人报名, 0为无, 1为有.

        hasPayInfo: false,//是否显示支付信息
        payCost: 0,//订单总价
        reduceCost: 0,//优惠
        needPayCost: 0,//实付金额
        orderNum: '',//订单编号
        payTime: '',//支付时间
        payWay: '',//支付方式
        orderId: '',//交易单号
        shoukuanAccount: ''//收款账户
    },
    onLoad: function (options) {
        let that = this;
        if (options) {
            applyId = options.applyId;
        }
        applyResult = 0;
        session.saveApplyInfo({current: 0, infos: []})
        this.getApplyDetail();
    },
    /**
     * 收到上一个页面返回的数据
     */
    recvData: function (result) {
        applyResult = result;
    },
    getApplyDetail: function () {
        let that = this;
        actApi.applyDetail({
                data: {
                    applyID: applyId,
                }
            }, function (res) {
                console.log(JSON.stringify(res.data));
                let detailType = 0;
                let applyInfo = res.data.data.applyInfos[0];
                let actInfo = res.data.data.actInfo;
                let clubInfo = res.data.data.clubInfo;
                let orderInfo = res.data.data.orderInfo;
                let payee = res.data.data.payee;
                let cancelApplyAble = true;
                if (applyInfo.applyStatus == 1 && applyInfo.applyUserType == 0) {//自己报名成功
                    detailType = 1;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名成功';
                } else if (applyInfo.applyStatus == 1 && applyInfo.applyUserType == 1) {//帮人报名成功
                    detailType = 2;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名成功';
                    cancelApplyAble = false;
                } else if ((actInfo.howToPay == 2 && applyInfo.payStatus == 2 && applyInfo.applyStatus == 0)
                    || (actInfo.howToPay != 2 && applyInfo.applyStatus == 0)) {//待审核
                    detailType = 3;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名审核中';
                } else if (actInfo.howToPay == 2 && applyInfo.payStatus == 1) {//待付款
                    detailType = 4;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '待付款';
                } else if (actInfo.howToPay == 2 && applyInfo.payStatus == 6) {
                    detailType = 5;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名取消';
                } else if (applyInfo.applyStatus == 4) {//审核不通过
                    detailType = 6;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名取消';
                } else if (applyInfo.applyStatus == 3) {//主办方拒绝
                    detailType = 7;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名取消';
                } else if (applyInfo.applyStatus == 2) {//报名者取消
                    detailType = 8;
                    that.data.applyStatusIco = '';
                    that.data.applyStatusText = '报名取消';
                }
                that.setData({
                    clubInfo: clubInfo,
                    actInfo: actInfo,
                    applyInfo: applyInfo,
                    costAct: actInfo.howToPay == 2,
                    cancelApplyAble: cancelApplyAble,
                    detailType: detailType,
                    applyStatusIco: that.data.applyStatusIco,
                    applyStatusText: that.data.applyStatusText,
                    actTitle: actInfo.actTitle,
                    host: "主办方：" + clubInfo.clubTitle,
                    actTime: actInfo.activityTime,
                    nickAndPhone: applyInfo.userName + "-" + applyInfo.mobile,
                    ticketName: actInfo.howToPay == 2 ? applyInfo.ticketName : "免费体验票",
                    ticketCost: actInfo.howToPay == 2 ? "¥" + applyInfo.ticketCost / 100 : "免费",
                    hasPayInfo: actInfo.howToPay == 2 && applyInfo.payStatus == 2,//付费活动已付款，有支付信息
                    payCost: orderInfo.orderMoney / 100,
                    reduceCost: orderInfo.offersMoney / 100,
                    needPayCost: orderInfo.payMoney / 100,
                    orderNum: orderInfo.payNo,
                    payTime: utils.formatTime7(orderInfo.payTime),
                    payWay: orderInfo.payWayName,
                    orderId: orderInfo.orderID,
                    shoukuanAccount: payee.nick + "-" + payee.mobile,
                    qrcode: applyInfo.qrcode,
                    hasHelpApply: res.data.data.hasHelpApply,
                });
            },
            function (res) {
                let errorMsg = utils.getErrorMsg(res);
                app.wxService.showModal({title: '报名详情加载失败', content: errorMsg.title + '；' + errorMsg.content})
            },
            function (res) {
                console.log(res)
            }
        );
    },
    goToActDetail: function (e) {
        app.wxService.navigateTo("activity/act_detail/act_detail", {
            clubID: this.data.clubInfo.clubID,
            activityID: this.data.actInfo.actID
        })
    },
    cancelApply: function (e) {//取消报名
        if (this.data.hasHelpApply) {//多人报名。去我的报名列表编辑页面
            app.wxService.navigateTo('activity/applylist/applylist', {activityId: this.data.actInfo.actID, type: 0});
        } else {//单人报名，直接取消
            let that = this;
            let cancelReason = ["个人行程有变，参加不了了", "不符合报名条件，主办方拒绝参加", "主办方变更了活动信息",
                "实际情况跟活动信息不符", "主办方取消了活动", "其他原因"];
            wx.showActionSheet({
                itemList: cancelReason,
                success: function (res) {
                    let reason = cancelReason[res.tapIndex];
                    if (reason) {
                        actApi.cancelApplySelf({
                            data: {
                                actID: that.data.actInfo.actID,
                                applyID: applyId,
                                reason: reason,
                            }
                        }, function (res) {
                            app.wxService.showToast("取消报名成功");
                            that.getApplyDetail();
                        }, function (res) {
                            let errorMsg = utils.getErrorMsg(res);
                            app.wxService.showModal({
                                title: '取消报名失败',
                                content: errorMsg.title + '；' + errorMsg.content
                            });
                        }, function (res) {
                            console.log(res);
                            that.loadApplyList();
                        });
                    }
                }
            })
        }
    },
    editApply: function (e) {//编辑报名
        app.wxService.navigateTo('activity/apply_page/apply_page', {
            activityId: this.data.actInfo.actID,
            applyId: this.data.applyInfo.applyID,
            type: 2,
        });
    },
    helpApply: function (e) {//帮人报名
        app.wxService.navigateTo('activity/applylist/applylist', {activityId: this.data.actInfo.actID, type: 1});
    },
    retryApply: function (e) {//重新报名
        app.wxService.navigateTo('activity/apply_page/apply_page', {activityId: this.data.actInfo.actID, type: 0})
    },
    hideAuthDialog() {
        this.setData({dialogInfo: {applySucceed: ''}});
    },
    /**
     * 显示报名成功弹窗
     * @param check 0、报名成功；1、待审核
     */
    showApplySuccessDialog: function (check) {
        this.setData({
            dialogInfo: {
                check: check,
                applySucceed: 'opacity:1;pointer-events:auto;'
            }
        })
    },
    hideToasts: function () {//报名成功弹窗确认按钮
        this.hideAuthDialog();
    },
    onShow: function () {
        let that = this;
        switch (applyResult) {
            case 1://对应需求文档情况1 - 报名成功, 新绑定了报名手机号.
            case 3://对应需求文档情况3 - 报名成功.
                setTimeout(function () {//要延迟500毫秒才能保证页面正确跳转
                    if (that.data.costAct) {
                        app.wxService.showToast({title: "去支付", ico: "loading"});
                        applyResult = 0;
                        that.goToPay();
                    } else {
                        that.showApplySuccessDialog(0)
                    }
                }, 200);
                break;
            case 2://对应需求文档情况2 - 报名成功待审核, 新绑定了报名手机号.
            case 4://对应需求文档情况4 - 报名成功待审核.
                setTimeout(function () {//要延迟500毫秒才能保证页面正确跳转
                    if (that.data.costAct) {
                        app.wxService.showToast({title: "去支付", ico: "loading"});
                        applyResult = 0;
                        that.goToPay();
                    } else {
                        that.showApplySuccessDialog(1)
                    }
                }, 200);
                break;
            case 5://修改报名资料成功
                that.getApplyDetail();
                app.wxService.showToast("修改成功");
                break;
            case 101://支付成功,弹出支付成功dialog
                setTimeout(function () {//要延迟500毫秒
                    switch (applyResult) {
                        case 1://对应需求文档情况1 - 报名成功, 新绑定了报名手机号.
                        case 3://对应需求文档情况3 - 报名成功.
                            that.showApplySuccessDialog(0);
                            break;
                        case 2://对应需求文档情况2 - 报名成功待审核, 新绑定了报名手机号.
                        case 4://对应需求文档情况4 - 报名成功待审核.
                            that.showApplySuccessDialog(1);
                            break;
                    }
                }, 200);
                break;
            case 102://支付失败
                setTimeout(function () {//要延迟500毫秒
                    app.wxService.showModal({title: "提示", content: "报名费用支付失败"})
                }, 200);
                break;
            case 201://报名页面点击立即报名，先退回报名详情页面再进入applylist页面
                applyResult = 0;
                app.wxService.navigateTo('activity/applylist/applylist', {activityId: activityId, type: 1});
                break;
        }
    },
});