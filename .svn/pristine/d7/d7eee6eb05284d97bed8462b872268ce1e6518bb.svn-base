Page({
    data: {
        resultArray:[],
        tickets:[],
        activityID:0,
        hiddenEmail:true,
    }
    ,
    tapForExport(e) {

        var activityID = this.data.activityID
        var that = this
        wx.showActionSheet({
            itemList: ['查看报名表格', '发送到邮箱'],
            success: function (res) {

                if(res.tapIndex == 0){
                    //表格
                    wx.navigateTo({
                    url: '../apply_form/apply_form?activityID='+activityID,
                })

                }else if(res.tapIndex == 1){
                    //邮箱
                    console.log('邮箱登录')
                    that.setData({
                        hiddenEmail:false,
                    })
                }
            },
            fail: function (res) {
                console.log(res.errMsg)
            }
        })
    },
    //组：展开 关闭
    tapGroupForDisplay:function(e){
        console.log(e)
        var index = e.currentTarget.id
        var resultArray = this.data.resultArray
        resultArray[index].open = !resultArray[index].open
        this.setData({
            resultArray:resultArray
        })
    },
    //单元格：展开 关闭
    tapRowForDisplay:function(e){
        var x = e.currentTarget.dataset.x
        var y = e.currentTarget.dataset.y
        var resultArray = this.data.resultArray;

       for(var i=0;i<resultArray.length;i++){
           var item = resultArray[i]
           for(var j=0;j<item.applys.length;j++){
               var apply = item.applys[j]

               if(i == x && j == y){
                 apply.open = !apply.open
               }else{
                 apply.open = false;
               }
           }
       }
        this.setData({
            resultArray:resultArray
        })
        console.log(e)
    },
    tapApplySmallButton:function(e){
        var x = e.currentTarget.dataset.x
        var y = e.currentTarget.dataset.y
        var tag = e.currentTarget.dataset.tag
        var resultArray = this.data.resultArray;
        var group = resultArray[x];
        var apply = group.applys[y]

        if(tag == 1){
            //编辑
            var activityID = this.data.activityID
            var nick = apply.user.nick
            var howToPay = apply.howToPay
            wx.navigateTo({
              url: '../edit_apply/edit_apply?activityID='+activityID+'&applyID='+apply.applyID+'&nick='+nick+'&howToPay='+howToPay,
            })

        }else if(tag == 2){
            //电话
            var phone = apply.user.mobile
            wx.makePhoneCall({
                phoneNumber: phone, //此号码并非真实电话号码，仅用于测试
                success:function(){
                    console.log("拨打电话成功！")
                },
                fail:function(){
                    console.log("拨打电话失败！")
                }
            })

        }
        
        console.log('tag = '+tag)
        console.log(apply)
    },
    touchCancel:function(e){
        this.setData({
            hiddenEmail:true,
        })
    },
    touchAddNew:function(e){
        this.setData({
            hiddenEmail:true,
        })
        this.requestSendEmail(this.data.emailText)
    },
    titleInput:function(e){
        this.data.emailText = e.detail.value
    },

    onLoad: function (options) {
        
        this.setData({
            activityID:options.activityID,
        })
        this.requestAllApplyList(options.activityID);
        // 页面初始化 options为页面跳转所带来的参数
    },
    onReady: function () {
        // 页面渲染完成

    },
    onShow: function () {
        // 页面显示
        this.requestAllApplyList(this.data.activityID);
    },
    onHide: function () {
        // 页面隐藏
    },
    onUnload: function () {
        // 页面关闭
    },

    requestSendEmail:function(email){
        var that = this 
        var activityID = this.data.activityID
        getApp().api('manageApi').sendEmail({
            data:{
                activity_id:activityID,
                email:email,
                type:1,
            }},
            function success(res){
                console.log(res);
            },
            function fail(res){

            },
    
        )
    },

    requestAllApplyList:function(activityID){
        var that = this 
        getApp().api('manageApi').getAllApplyList({
            data:{
                activity_id:activityID,
                start:0,
                count:90000
            }},
            function success(res){
                console.log(res);
                console.log('获取费用列表');
                var data = res.data
                that.handleData(data)

            },
            function fail(res){

            },
    
        )
    },
    handleData:function(options){
        var tickets = options.tickets
        var applys = options.applys
        var groups = options.groups

        this.data.tickets = tickets

        var allApplyArray = new Array()
 
        for(var i=0;i<groups.length;i++){
            var item = groups[i]
            for(var j=0;j<item.applys.length;j++){
                var apply = item.applys[j]
                allApplyArray.push(apply)
            }
        }
        for(var i=0;i<applys.length;i++){
            var apply = applys[i]
            allApplyArray.push(apply)
        }

       //
       for(var i=0;i<allApplyArray.length;i++){
            var apply = allApplyArray[i];
            apply.fieldString = this.getApplyFieldString(apply.applyFieldTxt)
            var sex = '女'
            if(apply.user.sex == 2){
                sex = '男'
            }
            apply.baseString = sex + ' ' + apply.user.mobile

            if(apply.howToPay > 1){
                // apply.price = this.getTicketPrice(apply.ticketID)
                apply.open = false;
                apply.payString = this.getPayString(apply.payStatus,apply.payType)
            }
        }

        var resultArray = new Array()
        for(var i=0;i<tickets.length;i++){
            var ticket = tickets[i]
            var tempArray = new Array()
            for(var j=0;j<allApplyArray.length;j++){
                var apply = allApplyArray[j]
                apply.open = false
                if(ticket.name == apply.ticketName){
                    tempArray.push(apply)
                }
            }
            var open = (i==0)?true:false
            if(tempArray.length > 0){
                var item = {
                    open:open,
                    ticket:ticket,
                    count:tempArray.length,
                    applys:tempArray
                }
                resultArray.push(item)
            }
        }
        console.log(resultArray)
        this.setData({
            resultArray:resultArray
        })
    },
    getTicketPrice:function(ticketID){
        var price = 0
        var tickets = this.data.tickets
        for(var i=0;i<tickets.length;i++){
            var ticket = tickets[i]
            if(ticket.ticketID == ticketID){
                price = ticket.cost/100.0;
                break
            }
        }
        return price
    },
    getPayString:function(payStatus,payType){
        var payString = ''
        if(payStatus == 7){
            payString = '其他支付方式 (未付款)'
        }else if(payStatus == 8){
            payString = '其他支付方式 (已付款)'
        }else if(payStatus == 4 ||payStatus == 2 ){
            payString = '已在线退款'
        }else{
            if(payStatus == 1 ||payStatus == 6){
                payString = ''
            }else{
                payStrin = payType
            }
        }
        return payString
    },
    getApplyFieldString:function(fieldJson){
        var fieldString = ''
        var obj = JSON.parse(fieldJson)
        for(var key in obj){
            if(fieldString == ''){
                fieldString = key+': '+obj[key]
            }else{
                fieldString = fieldString + ' / '+key+': '+obj[key]
            }
        }
        return fieldString
    },
})