var app = getApp()
import storage from '../../../utils/storage.js'
Page({
  data: {
    point_color: '0,0,0',
    color: [
      '255,58,58',
      '255,174,58',
      '255,222,0',
      '125,204,77',
      '54,170,251',
      '201,115,255',
      '0,0,0',
    ],
    contents: [],
    // back: 's',
    applyFields: [
      { isCheck: true, text: '昵称' },
      { isCheck: true, text: '手机' },
      { isCheck: false, text: '性别' },
      { isCheck: false, text: '真实姓名' },
      { isCheck: false, text: '身份证' },
      { isCheck: false, text: '+' }
    ],
    pos: 0,
    input_auto: true,
    font_color: '255,222,0',
   
    isWeight: false,
    test: '',
    isChange: false,
    isShowColor: true,

    actop:{
      actId:'',
      title	:	""	,	//	活动主题（标题）
      content	:	""	,	//	活动内容
      max_apply_count	:	0	,	//	活动最多报名人数, 如果不限制传入-1
      deadline	:	0	,	//	报名截止时间（毫秒时间戳）
      begin	:	0	,	//	活动开始时间（毫秒时间戳）
      end	:	0	,	//	活动截止时间（毫秒时间戳）
      lat	:	0	,	//	经度
      lng	:	0	,	//	纬度
      address	:	"0"	,	//	活动地址
      apply_check	:	0	,	//	是否开启报名审核 1:是 0:否 默认: 0
      fields	:	"0"	,	//	非必需字段
      cost	:	0	,	//	如果是免费就传0 收费就传具体的数字 默认: 免费
      cost_desc	:	""	,	//	活动费用描述
      guide	:	""	,	//	报名须知
      auto_create_group	:	0	,	//	是否自动创建群 1:创建 0:不创建 默认: 0
      cover	:	""	,	//	显示指定封面 未指定时提取活动内容第一张图
      act_type	:	1	,	//	活动类型（1：俱乐部公开活动 2：俱乐部内部活动 3：私人活动）
      helper_apply	:	1	,	//	是否开启帮人报名功能 1:是 2:否 默认: 1
      user_lat	:	0	,	//	发布活动时，用户所在的纬度, 需要增大一百万倍再传过来
      user_lng	:	0	,	//	发布活动时，用户所在的经度, 需要增大一百万倍再传过来
      user_location	:	""	,	//	发布活动时，用户所在的一级城市
      act_location	:	""	,	//	活动地址（发布活动时，标记的活动位置，即参数address）所在一级城市
      act_type	:	1	,	//	活动类型（1：俱乐部公开活动 2：俱乐部内部活动 3：私人活动）
      need_to_pay	:	1	,	//	是否是收费活动（1：不收费 2：收费）默认 1: 不收费
      how_to_pay	:	1	,	//	付费方式（1：无(包括该版本前的非在线收费活动) 2：在线付费）默认：1:无
      payee_account	:	1	,	//	收款账户ID（即收款人用户ID，tips：不是会员号）
      cancel_apply	:	1	,	//	是否可以取消报名，1是可以，0是不可以
      begin_sms_time	:	3600,//活动开始前短信提醒时间，默认24小时前，单位：秒， 如活动开始一小时前提醒，begin_sms_time=3600. 不发送短信传-1
     // begin_sms_msg	:	"您报名的活动（xxxxxxx）将于1月26日18时49分开始，打开超级俱乐部APP查看详情，或点击 s.iweju.com 下载	",	//	活动开始前的短信内容
      data_type	:	0	,//	数据类型，0是发布正式活动(默认)，1是保存为草稿
      image:""
    }
  },
  position: -1,
  input_content: '',
  onLoad: function (e) {
    storage.saveSync("key", "350c52f9f5f10ad6000083e1905b7ef7")
   
    //var actId = e.actId;
    var actId = '591657';
    if(actId && actId!=''){//编辑活动
       var param={}
       var data={}
       param.method = "GET";   
       data.activity_id = actId;
       data.load_model = 0;
       param.data=data;
       app.origanizeApi.getActDetail(param, res=>{ 
          console.info("===========");
          console.info(res.data.activity); 
          var actInfo = res.data.activity;
            //初始化标题
          this.initTitle(actInfo);
          //初始化内容
          this.initContent(actInfo);
          //初始化自定义填写项
          this.initApplyItem(actInfo);
          //初始化报名人数 时间 地址
          this.initOther(actInfo);
          
          //初始化活动费用说明 金额 费用说明
          this.initPrice(actInfo);
          //this.initIszxPay(actInfo);        
          //初始化费用
          this.initFee(actInfo);
          //初始化分组
          this.initGroup(actInfo);
          
          //初始化发送短信
          this.initSmsTime(actInfo);
          
          //初始化更多设置
          this.initSetMore(actInfo);
          
        })
    }else{//组织活动

    }
  },
  initTitle:function(actInfo){
    this.setData({actop:{title : actInfo.title}})
  },
  initContent:function(actInfo){
    
	},

initApplyItem:function(actInfo){
	console.info(2);
		var actForms = actInfo.applyFields;
		if(actForms.length > 0){
			
			var actForm = new Array();
			for(var i=0;i<actForms.length;i++){
				var fieldName = {}
				fieldName = { isCheck: true, text: actForms[i].fieldName };
				actForm[i] = fieldName;
			}		
			this.setData({ applyFields:actForm});
		
		}
	},
initOther:function(actInfo){
		//报名人数
		if(actInfo.apllyNum == -1){
			$('#apllyNum').val('不限');
		}else{
			$('#apllyNum').val(actInfo.apllyNum);
		}
		
		if(_actop._tmpId!=""&&_actop._tmpId!=null){
			_actop._initTime();
		}else{
			//活动时间
			if(actInfo.beginTime){
				$('#post_begintime').val(new Date(actInfo.beginTime).format("yyyy-MM-dd hh:mm"));
			}
			if(actInfo.endTime){
				$('#post_endtime').val(new Date(actInfo.endTime).format("yyyy-MM-dd hh:mm"));
			}
			if(actInfo.deadlineTime){
				$('#post_deadlinetime').val(new Date(actInfo.deadlineTime).format("yyyy-MM-dd hh:mm"));
			}
		}
		
		//活动地址
		if(actInfo.actAddress){
			$('#actAddress').text(actInfo.actAddress).css({ color: "#8dbff3" });
			$('#actAddress').attr('jwd', actInfo.lngInt + ',' + actInfo.latInt);
		}else{
			$('#actAddress').text("标记活动位置，可不标");
		}
		
	},
  initPrice:function(actInfo){
		$('#costText').focus(function(){
			if(actInfo.haveApplyNum>0 && _actop._tmpId==""){
				_toast._show('已有人报名,活动费用不可修改');
				$('#costText').blur();
				return;
			}
			/*_actop._findIsApply(actInfo.actId);
			if(_actop._isapply){
				_toast._show('活动已有人报名,不可编辑活动费用');
				$('#costText').blur();
				return;
			}*/
		});
		var flag = false;
		if(actInfo.needToPay==2){
			$('#price').text('收费');
			$('#cost').show(); 
			$('#costDesc').show();
			$("#zxpay").show();
			$('#costText').val(actInfo.cost/100.0);
			_actop._needPay = 2;
			$('#costDescText').text(actInfo.costDesc);//费用描述
			
			if(actInfo.apllyNum==-1){
				$('#waiapllyNum').val('不限');
			}else{
				$('#waiapllyNum').val(actInfo.apllyNum+'人');
				$('#feeApllyNum').val(actInfo.apllyNum);
			}
			if(actInfo.tickets != null){
				for(var i =0;i<actInfo.tickets.length;i++){
					if(actInfo.tickets[i].cost !=0){
						flag=true;
					}
				}
			}
		}else{
			$('#price').text('免费');
			if(actInfo.apllyNum==-1){
				$('#waiapllyNum').val('不限');
			}else{
				$('#waiapllyNum').val(actInfo.apllyNum+'人');
				$('#apllyNum').val(actInfo.apllyNum);
			}
			$('#applyNumItem').show();
			_actop._needPay = 1;
			$('#cost').hide(); 
			$('#costDesc').hide();
		}
		_actop._canRefund = actInfo.isRefund;
		
		
		if(flag){
			if(actInfo.isRefund==1){//可退款
				var refundTime = new Date(actInfo.refundTime).format('yyyy-MM-dd hh:mm:ss');
				_actop._refundTime =refundTime;
				$("#refundTime").val(refundTime);
				$("#refundment").text("活动开始前可申请退款");
				$("#refundment").css({"color":"#44adb4"});
			}else if(actInfo.isRefund==2){//活动开始前指定时间前可申请退款
				var refundTime = new Date(actInfo.refundTime).format('yyyy-MM-dd hh:mm:ss');
				_actop._refundTime =refundTime;
				$("#refundTime").val(refundTime);
				$("#refundment").text("指定时间前可申请退款");
				$("#refundment").css({"color":"#44adb4"});
			}else if(actInfo.isRefund==3){//不可退款
				$("#refundment").text("不支持退款");
				$("#refundment").css({"color":"#44adb4"});
			}else{
				$("#refundment").text("活动费用为0无须设置");
				$("#refundment").css({"color":":#999"});
			}
		}else{
			$("#refundment").text("活动费用为0无须设置");
			$("#refundment").css({"color":":#999"});
		}
		
		
	},
	initIszxPay:function(actInfo){
		var q = 1;
		if(actInfo.howToPay==2){
			_actop._showZOn(q);
		}else{
			_actop._showZOff(q);
		}
	},
	initFee:function(actInfo){
		if(actInfo.needToPay==2){
			//needToPay 
			_actop._needPay = actInfo.needToPay;
			_actop._howToPay = actInfo.howToPay;
			_actop._initfeeItems(actInfo);
			$('.showfee').show();
			$('.showunfee').hide();
			$('#feeDetail').show();
			$('#unfeeDetail').hide();
			var q = 1;
			if(actInfo.howToPay==2||actInfo.howToPay==3){
				_actop._showZOn(q);
				if(actInfo.howToPay==3){
					_actop._showOtherOn();
				}
			}else{
				_actop._showZOff(q);
			}
			_actop._setSubmit();
		}
	},
	initGroup:function(actInfo){
		if(actInfo.isGroupApply==1){//分组
			_actop._showGroupOn();
			
			if(actInfo.groupNum == -1){
				$('#groupNum').val('');//默认不限
			}else{
				$('#groupNum').val(actInfo.groupNum);
			}
			if(actInfo.groupMinMemberCount == -1){
				$('#groupminNum').val('');//默认不限
			}else{
				$('#groupminNum').val(actInfo.groupMinMemberCount);
			}
			if(actInfo.groupMaxMemberCount == -1){
				$('#groupmaxNum').val('');//默认不限
			}else{
				$('#groupmaxNum').val(actInfo.groupMaxMemberCount);
			}
			
		/*	$('#groupNum').val(actInfo.groupNum);
			$('#groupminNum').val(actInfo.groupMinMemberCount);
			$('#groupmaxNum').val(actInfo.groupMaxMemberCount);*/
			
			if(_actop._actDetail!=null&&_actop._actDetail.haveApplyGroupNum>0){
				$('#groupminNum').attr('readonly','readonly');
				$('#groupmaxNum').attr('readonly','readonly');
			}
		}else{
			_actop._showGroupOff();
		}
	},
	initSmsTime:function(actInfo){
		var time = actInfo.beginSmsTimeValue;
		_actop._smsTime = time;
		var hour = -1;
		if(time==-1){
			$('#messageName').html('不发送');
			_actop._messageTime(hour);
		}else{
			hour = time / 3600;
			$('#messageName').html('活动开始前'+hour+'小时');
			_actop._messageTime(hour);
		}
		var smsMsg = actInfo.beginSmsMsg;
		$('#smsMsg').text(smsMsg);
		
		//设置是否允许取消报名
//		var isQxApply = actInfo.cancelApply;
//		if(isQxApply==0){
//			_actop._showQOn();
//		}else{
//			_actop._showQOff();
//		}
	},
initSetMore:function(actInfo){
		$('.dot').hide();
		if(actInfo.actType == 3){
			_actop._actType = 3;
			$('#typeName').html('私人活动');
			$('.showOneOn').show();
			$('.showClubOn').hide();
			$('.showOpenOn').hide();
		}else if(actInfo.actType == 2){
			_actop._actType = 2;
			$('#typeName').html('俱乐部内活动');
			$('.showOneOn').hide();
			$('.showClubOn').show();
			$('.showOpenOn').hide();
		}else if(actInfo.actType == 1){
			_actop._actType = 1;
			$('#typeName').html('公开活动');
			$('.showOneOn').hide();
			$('.showClubOn').hide();
			$('.showOpenOn').show();
		}
		if(actInfo.cover != "" && actInfo.cover != null){
			$('#coverShow').html('<img class="actCover" src="'+actInfo.cover+'" height="30px" width="30px"  /> <img class="more" src="../img/arrow (2).png" height="14px" /> ')
			
			/*$(".actCover").attr("src",);//设置封面*/		
		}
		//不需要审核
		if(actInfo.applyCheck == 0){
			$('.son').hide();
			$('.soff').show();
			_actop._ischeck = 0;
		}else{//需要审核
			$('.soff').hide();
			$('.son').show();
			_actop._ischeck = 1;
		}
		
		//帮报开关
		if(actInfo.helperApply == 1){
			$('.yoff').hide();
			$('.yon').show();
			_actop._isHelp_apply = 1;
		}else{//2不允许帮报
			$('.yon').hide();
			$('.yoff').show();
			_actop._isHelp_apply = 2;
		}
		
		
		
		if(actInfo.autoCreateGroup == 1){
			$('.off').hide();
			$('.on').show();
			_actop._idAuto = true;
		}else{
			$('.on').hide();
			$('.off').show();
			_actop._idAuto = false;
		}
		if(actInfo.applyCheck == 1){
			$('.soff').hide();
			$('.son').show();
		}else{
			$('.son').hide();
			$('.soff').show();
		}
		$('.enrollNotice').text(actInfo.guide);
	},
initTime:function(){
		var nextTime2 = new Date((new Date().getTime()) + (86400000*7));
		var yy2 = nextTime2.getFullYear()
		var mm2 = (nextTime2.getMonth()+1<10)?('0'+(nextTime2.getMonth()+1)):(nextTime2.getMonth()+1);
		var dd2 = (nextTime2.getDate()<10?('0'+nextTime2.getDate()):nextTime2.getDate());
		$('#post_begintime').val(yy2+'-'+mm2+'-'+dd2+' 09:00');
		$('#post_endtime').val(yy2+'-'+mm2+'-'+dd2+' 18:00');
		/*$('#post_deadlinetime').val(yy2+'-'+mm2+'-'+dd2+' 09:00');*/
		$("#refundTime").val(yy2+'-'+mm2+'-'+dd2+' 09:00');
		//报名截止时间判断
		_actop._deadlinetime = yy2+'-'+mm2+'-'+dd2+' 09:00';
	},


  choose_img: function (e) {
    var that = this
    wx.chooseImage({
      count: 9, // 默认9
      sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
      sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
      success: function (res) {
        // 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
        var tempFilePaths = res.tempFilePaths
        console.log(tempFilePaths)
        var n_con = that.data.contents
        for (var i in tempFilePaths) {
          var a = { type: 'img', text: tempFilePaths[i] + '' }
          n_con.push(a)
        }
        that.setData({
          contents: n_con
        })
      }
    })
  },
  choose_voide: function (e) {
    var that = this
    var n_con = this.data.contents
    wx.chooseVideo({
      sourceType: ['album', 'camera'],
      maxDuration: 60,
      camera: 'back',
      success: function (res) {
        var a = { type: 'video', text: res.tempFilePath }
        n_con.push(a)
        that.setData({
          contents: n_con
        })
      }
    })
  }
  ,
  con_tap: function (e) {
    var pos = e.target.id
    var n_con = this.data.contents
    this.setData({
      pos: pos,
      test: n_con[pos].text,
      isChange: true
    })
  },
  ok: function (e) {
    console.log(e.detail.value)
    var that = this
    var n_con = this.data.contents
    if (e.detail.value != '') {
      if (n_con != '') {
        if (that.data.isChange == true) {
          n_con[that.data.pos].text = e.detail.value
        }
        else {
          if (n_con[that.data.pos].color == that.data.font_color && n_con[that.data.pos].weight == that.data.isWeight) {
            n_con[that.data.pos].text += e.detail.value
          }
          else {
            n_con.push({ type: 'text', text: e.detail.value, color: that.data.font_color, weight: that.data.isWeight })
          }
        }
      } else {
        n_con.push({ type: 'text', text: e.detail.value, color: that.data.font_color, weight: that.data.isWeight })
      }
      that.setData({
        contents: n_con,
        test: '',
        pos: 0,
        isChange: false
      })
    }
  },
  con_input: function (e) {
    var that = this
  }
  ,
  reset_pos: function (e) {
    this.position = -1
  },
  choose_color: function (e) {
    console.log(e.target.id)
    this.setData({
      point_color: this.data.color[e.target.id],
      font_color: this.data.color[e.target.id]
    })

  },
  choose_weight: function (e) {
    if (this.data.isChange) {
      var n_con = this.data.contents
      n_con[this.data.pos].weight = !this.data.isWeight
      this.setData({
        contents: n_con,
        isWeight: !this.data.isWeight
      })
    } else {
      this.setData({
        isWeight: !this.data.isWeight
      })
    }
  },
  test: function (e) {
    this.setData({
      test: 'sss'
    })
  },
  delete: function (e) {
    var that = this
    var n_con = this.data.contents
    wx.showActionSheet({
      itemList: ['删除'],
      success: function (res) {
        n_con.splice(e.target.id, 1)
        that.setData({
          contents: n_con
        })
      }
    })
  },
  show_color: function (e) {
    console.log('?')
    this.setData({
      isShowColor: !this.data.isShowColor
    })
  },
  user_choose: function (e) {
    console.log(e.target.id)
    var user_choose_list = this.data.user_choose_list
    user_choose_list[e.target.id].isCheck = !user_choose_list[e.target.id].isCheck
    this.setData({
      user_choose_list: user_choose_list
    })

  }
})
