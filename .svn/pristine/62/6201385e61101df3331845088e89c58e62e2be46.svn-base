/**
 * 支付页面
 * 待付订单详情接口：http://doc.iweju.com/FitNesse.WejuBaHttp.V222Doc.ActTest.MoneyOrderUnpayDetail222Doc
 */
const app = getApp();
const utils = app.util;
const actApi = app.api("actApi");

let unPayId = 17579;
let down = false;//是否可以开始倒计时
let authInput;
Page({
    data: {
        countDown: '',//剩余时间
        activityName: '活动名称',
        startTime: '11月12日 12:00',//开始时间
        applyInfos: [],//报名信息
        sumUnpayMoney: '',//总报名费用
        sumNeedPayMoney: '0',//需要支付的费用
        voiceAuth: 1,// 是否验证过语音验证码 0未验证，1已验证
        voicePhone: '',//验证的手机号码
        voiceInfo: '',//验证弹窗的提示信息
        applyExpiredTime: 0,//报名剩余时间
        agreenstatu: false,//是否同意服务协议
    },
    onLoad: function (options) {
        let that = this;
        if (options) {
            unPayId = options.unPayId;
        }
        actApi.getUnPayDetail({//获取付款详情
            data: {
                unpay_id: unPayId,
            }
        }, function (res) {
            console.log(JSON.stringify(res.data));
            let activity = res.data.unpay.unpayDetailInfo.activity;
            that.setData({
                activityName: activity.title,
                startTime: activity.beginTime,
                applyInfos: res.data.unpay.unpayDetailInfo.applyInfos,
                sumNeedPayMoney: res.data.unpay.sumNeedPayMoney,
                sumUnpayMoney: res.data.unpay.sumUnpayMoney,
                applyExpiredTime: res.data.applyExpiredTime,
            });
            if(res.data.applyExpiredTime > 0){
                countdown(that);
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '获取订单详情', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(res)
        })
    },
    payAction: function () {//确认支付按钮
        let that = this;
        actApi.pay({
            data: {
                order_id: unPayId,
            }
        }, function (res) {
            console.log(JSON.stringify(res.data));
            that.goWechatPay(res);
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '获取支付信息失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
            console.log(res);
        });
    },
    agreenbtn: function (e) {//同意服务协议
        this.setData({
            agreenstatu: !this.data.agreenstatu
        })
    },
    goWechatPay: function (res) {//开始微信支付
        wx.requestPayment({
            timeStamp: "" + res.data.prepayParams.timestamp,
            nonceStr: "" + res.data.prepayParams.nonceStr,
            package: 'prepay_id=' + res.data.prepayParams.prepayID,
            signType: 'MD5',
            paySign: res.data.prepayParams.sign,
            success: function (res) {//微信返回的支付成功
                console.debug(res);
                let pages = getCurrentPages();
                let currPage = pages[pages.length - 1];   //当前页面
                let prevPage = pages[pages.length - 2];  //上一个页面
                prevPage.recvData(101);//返回act_detail result==101，代表支付成功
                app.wxService.navigateBack();
            },
            fail: function () {
                app.wxService.showToast("微信支付失败",2000)
            },
            complete: function () {
            }
        })
    }
})

function countdown(that) {
    var remainTime = that.data.applyExpiredTime - new Date().getTime();
    var remainTimeStr = '';
    if (remainTime > 0) {
        remainTimeStr = dateformat(remainTime);
    }
    that.setData({
        countDown: remainTimeStr
    });
    if(remainTimeStr == ''){
        return;
    }
    var time = setTimeout(function () {
        countdown(that);
    }
        , 1000)
}

// 时间格式化输出
function dateformat(micro_second) {
    var remain_time = micro_second - new Date().getTime();
    // 秒数
    var second = Math.floor(micro_second / 1000);
    // 分钟位
    var min = Math.floor(second / 60);
    // 秒位
    var sec = second % 60;
    if (min < 10) {
        min = "0" + min;
    }
    if (sec < 10) {
        sec = "0" + sec;
    }
    return min + ":" + sec;
}