const app = getApp();
const actApi = app.api("actApi");
const userApi = app.api("userApi");
const utils = app.util;
let activityId, applyId;//活动ID、报名Id
const session = app.session;

let inputData = new Object();
let applyInfos;
Page({
    data: {
        type: 0,//0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式
        isCost: false,
        selectTicketIndex: 0,
        selectTicket: {}, //已选择的票价
        tickets: [], //票价列表
        fields: [], //需要填写的信息列表

        //验证手机的字段
        authCode: "",
        interval: "",
        authDialog: {
            phone: '',
            modalShowStyle: "",
            focus: false,
            status: 0, //0: 显示发送验证码的按钮 1: 倒数中
        },
        countDown: 30,
    },
    ticketSelect: function (e) {//费用选择器
        this.setData({
            selectTicketIndex: e.detail.value,
            selectTicket: this.data.tickets[e.detail.value],
        })
    },
    pickerEvent: function (e) {//选择器事件
        let that = this;
        let index = e.currentTarget.dataset.index;
        let item = e.currentTarget.dataset.item;
        that.data.fields[index].select = e.detail.value;
        that.data.fields[index].defaultValue = item.option[e.detail.value];
        this.setData({
            fields: that.data.fields,
        });
        inputData[item.fieldName] = item.option[e.detail.value];
        console.log(inputData, e);
    },
    inputEvent: function (e) {//输入框事件
        let index = e.currentTarget.dataset.index;
        let item = e.currentTarget.dataset.item;

        inputData[item.fieldName] = e.detail.value;
        this.data.fields[index].defaultValue = e.detail.value;
        console.log(inputData);
    },
    /**
     * type :0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式
     * @param param{type:0,activityId:123}
     */
    onLoad: function (param) {
        let that = this;
        activityId = param.activityId;
        that.setData({
            type: param.type
        });
        if (that.data.type == 0) {
            app.wxService.setNavigationBarTitle("报名活动");
            that.loadApplyInfo();
        } else if (that.data.type == 1) {
            app.wxService.setNavigationBarTitle("帮人报名");
            applyInfos = session.getApplyInfo();
            if (!applyInfos) {
                applyInfos = {current: 0, infos: []};
                that.loadApplyInfo();
            } else if (!applyInfos.infos) {
                applyInfos = {current: 0, infos: []};
                that.loadApplyInfo();
            } else {//帮人报名编辑模式
                let applyInfo = applyInfos.infos[applyInfos.current];
                console.log(applyInfo);
                if (applyInfo) {
                    that.setData({
                        isCost: applyInfo.isCost,
                        selectTicketIndex: applyInfo.selectTicketIndex,
                        selectTicket: applyInfo.selectTicket,//已选择的票价
                        tickets: applyInfo.tickets,//票价列表
                        fields: applyInfo.fields,//需要填写的信息列表
                    });
                } else {
                    that.loadApplyInfo();
                }
            }
        } else if (that.data.type == 2) {
            app.wxService.setNavigationBarTitle("修改报名资料");
            applyId = param.applyId;
            that.loadApplyInfo();
        }
        console.log(param);
    },
    loadApplyInfo: function () {//获取报名需要填写的信息
        let that = this;
        actApi.getApplyInfo({
            data: {
                activity_id: activityId,
                apply_id: applyId,
            },
        }, function (res) {
            console.log(JSON.stringify(res.data));
            let data = res.data;
            let fields = res.data.fields;
            let tickets = res.data.tickets;
            fields.forEach(function (item) {
                if (item.fieldType == 2 && item.option) {//选择
                    item.option = item.option.split(',');
                    if (!item.defaultValue) {
                        item.defaultValue = item.option[0];
                    }
                    item.select = item.option.indexOf(item.defaultValue);
                    inputData[item.fieldName] = item.option[0];
                } else {//文本填写
                    if (that.data.type == 2) {
                        inputData[item.fieldName] = item.defaultValue;
                    } else {
                        inputData[item.fieldName] = null;
                    }
                    if (item.fieldName == "手机") {
                        item.inputType = "number";
                        item.placeHolder = "请填写手机";
                        item.maxText = 11;
                    } else {
                        item.inputType = "text";
                        item.maxText = 30;
                    }
                    if (item.fieldName == "昵称") {
                        item.placeHolder = "请填写昵称";
                        item.maxText = 10;
                    }
                }
            });

            if (tickets && tickets.length != 0) {//付费活动
                let tickets = res.data.tickets;
                let selectTicket = data.tickets[0];
                tickets.forEach(function (item) {
                    item.desc = item.name + "：" + (item.cost / 100);
                });
                that.setData({
                    isCost: true,
                    fields: data.fields,
                    selectTicketIndex: 0,
                    selectTicket: selectTicket,
                    tickets: tickets,
                });
            } else {//免费活动
                that.setData({
                    isCost: false,
                    fields: data.fields,
                });
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '报名信息加载失败', content: errorMsg.title + '；' + errorMsg.content})
        }, function (res) {
        });
    },
    checkInput: function () {//检查填写信息是否有错误
        for (let item of this.data.fields) {
            let value = inputData[item.fieldName];
            if (!value || value.lengh == 0) {
                app.wxService.showModal({title: "报名信息填写错误", content: item.fieldName + "为空"});
                return false;
            }
        }
        return true;
    },
    greenButton: function () {//立即报名、或”保存“按钮
        //type: 0、普通报名模式；1、帮报名填写模式；2、修改报名资料模式
        let that = this;
        if (that.data.type == 0) {//立即报名
            that.apply();
        } else if (that.data.type == 1) {//帮报名,将数据传送给报名列表
            if (this.checkInput()) {
                let applyInfo = {
                    isCost: that.data.isCost,
                    selectTicketIndex: that.data.selectTicketIndex,
                    selectTicket: that.data.selectTicket,//已选择的票价
                    tickets: that.data.tickets,//票价列表
                    fields: that.data.fields,//需要填写的信息列表
                };
                applyInfos.infos[applyInfos.current] = applyInfo;
                session.saveApplyInfo(applyInfos);
                app.wxService.navigateBack();
            }
        } else if (this.data.type == 2) {//修改报名资料
            that.update();
        }
    },
    update: function () {//修改报名资料
        let that = this;
        let data = JSON.stringify(inputData);
        console.log(data);
        if (this.checkInput()) {
            actApi.updateApplyInfo({
                    data: {
                        actID: activityId,
                        data: data,
                        ticketID: that.data.selectTicket.ticketID,
                        phone: inputData["手机"],
                        applyPlatform: 3,
                        applyID: applyId,
                    },
                    method: "POST",
                }
                , function (res) {
                    let pages = getCurrentPages();
                    let currPage = pages[pages.length - 1];   //当前页面
                    let prevPage = pages[pages.length - 2];  //上一个页面
                    prevPage.recvData(5);
                    app.wxService.navigateBack();
                }, function (res) {
                    let errorMsg = utils.getErrorMsg(res);
                    app.wxService.showModal({title: '保存失败', content: errorMsg.title + '；' + errorMsg.content})
                }, function (res) {
                    console.log(res)
                });
        }
    },
    apply: function () { //立即报名
        let that = this;
        let data = JSON.stringify(inputData);
        console.log(data);
        if (!this.checkInput()) {
            getApp().wxService.showToast("报名信息有误")
            return
        } else if (getApp().session.isTempUser()) {
            this.validatePhone()
            return
        }

        actApi.actApplySelf({
            data: {
                activity_id: activityId,
                data: data,
                ticket_id: that.data.selectTicket.ticketID,
                phone: inputData["手机"],
                paid: 0,
                applyPlatform: 3,
            },
            method: "POST",
        }, function (res) {
            app.wxService.showToast("报名成功");
            let result = res.data.result;
            if (result > 0) { //报名成功，返回活动详情页面，并带回值
                let pages = getCurrentPages();
                let currPage = pages[pages.length - 1]; //当前页面
                let prevPage = pages[pages.length - 2]; //上一个页面
                prevPage.recvData(result);
                app.wxService.navigateBack();
            } else { //报名失败
                // -1: 需要验证手机, 需要弹出验证码输入框.
                // -2: 手机验证码验证失败.
                // -3: 临时用户输入的手机号已关联了老用户.
                let error = ""; //报名错误信息
                switch (result) {
                    case -1:
                        error = '需要验证手机, 需要弹出验证码输入框.';
                        break;
                    case -2:
                        error = '手机验证码错误';
                        break;
                    case -3:
                        error = '手机号已关联了老用户';
                        break;
                }
                app.wxService.showModal({
                    title: '报名失败',
                    content: errorMsg.title + '；' + errorMsg.content
                })
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({
                title: '报名失败',
                content: errorMsg.title + '；' + errorMsg.content
            })
        }, function (res) {
            console.log(res)
        });
    },
    helpApply: function (e) { //帮人报名(立即报名页面点击帮人报名)
        let that = this;
        if (this.checkInput()) {
            let applyInfo = {
                isSelf: true,//是否自己的报名信息
                isCost: that.data.isCost,
                selectTicketIndex: that.data.selectTicketIndex,
                selectTicket: that.data.selectTicket,//已选择的票价
                tickets: that.data.tickets,//票价列表
                fields: that.data.fields,//需要填写的信息列表
            };
            applyInfos = {current: 0, infos: [applyInfo]};
            session.saveApplyInfo(applyInfos);
            let pages = getCurrentPages();
            let currPage = pages[pages.length - 1]; //当前页面
            let prevPage = pages[pages.length - 2]; //上一个页面
            prevPage.recvData(201);
            app.wxService.navigateBack();
        }
    },

    /**
     * 微信小程序临时用户，验证手机号码
     */
    validatePhone: function () {
        let phone = inputData["手机"]
        let that = this
        userApi.sendAuthCode({
            data: {
                auth_type: 2,
                phone: phone
            }
        }, res => {
            let interval = setInterval(() => {
                let leftTime = that.data.countDown - 1;
                let authDialog = that.data.authDialog
                if (leftTime > 0) {
                    that.setData({
                        countDown: leftTime
                    })
                } else {
                    clearInterval(interval)
                    authDialog.status = 0
                    that.setData({
                        authDialog: authDialog,
                        countDown: 30
                    })
                }
            }, 1000)
            let authDialog = that.data.authDialog
            authDialog.phone = phone
            authDialog.status = 1
            authDialog.focus = true
            authDialog.modalShowStyle = "opacity:1;pointer-events:auto;"
            that.setData({
                authDialog: authDialog,
                interval: interval,
                countDown: 30
            })
        }, res => {
            let errorData = app.util.getErrorMsg(res)
            let errorMsg = errorData.content
            if (errorMsg == '') {
                errorMsg = "发送验证码失败"
            }
            app.wxService.showToast(errorMsg)
        })
    },

    getAuthCode() {
        //点击发送验证码
        this.validatePhone()
    },

    authInput(e) {
        //输入验证码
        this.data.authCode = e.detail.value
    },

    touchCancel() {
        //点击取消
        clearInterval(this.data.interval)
        let authDialog = this.data.authDialog
        authDialog.modalShowStyle = ""
        authDialog.focus = false
        this.setData({
            authDialog: authDialog,
        })
    },

    touchAddNew() {
        let that = this
        if (this.data.authCode == '') {
            app.wxService.showToast('验证码不能为空')
            return
        }
        clearInterval(this.data.interval)
        //点击确定
        let authDialog = this.data.authDialog
        authDialog.modalShowStyle = ""
        authDialog.focus = false
        this.setData({
            authDialog: authDialog,
        })

        let code = this.data.authCode
        let phone = this.data.phone
        userApi.bindPhone({
            method: 'POST',
            data: {
                code: code,
                phone: phone,
            }
        }, res => {
            //绑定手机成功, 重新登录一下
            getApp().relogin(res => {
                that.apply()
            })
        }, res => {
            let errorData = app.util.getErrorMsg(res)
            let errorMsg = errorData.content
            if (errorMsg == '') {
                errorMsg = "绑定手机号码失败"
            }
            app.wxService.showToast(errorMsg)
        })
    },
});