const app = getApp();
const utils = app.util;
const actApi = app.api("actApi");

let activityId;
Page({
    data: {
        type: 0,//0、编辑模式（修改报名资料、取消报名）；1、报名模式，一次帮报多个名额
        applyList: [],//报名数据列表
    },
    onLoad: function (param) {
        activityId = param.activityId;
        if (param.type == 0 || param.type == 1) {
            this.setData({
                type: param.type
            })
        }
        this.loadApplyList();
    },
    editApply: function (e) {//编辑按钮
        let item = e.currentTarget.dataset.item;
        app.wxService.navigateTo("activity/apply_page/apply_page", {activityId: activityId, applyId: item.id, type: 2})
    },
    deleteApply: function (e) {//删除按钮
        let that = this;
        let item = e.currentTarget.dataset.item;
        app.wxService.showModal({title: "温馨提示", content: '是否删除\"' + item.userName + '\"的报名'}, function (res) {
            if (res.confirm) {
                that.cancelApply(item.id);
            }
        })
    },
    apply: function (e) {//立即报名按钮
    },
    helpAplly: function () {//帮人报名按钮
    },
    loadApplyList: function () {//我的报名列表
        let that = this;
        actApi.getMyApplyList({
            data: {
                activity_id: activityId,
            }
        }, function (res) {
            console.log(JSON.stringify(res.data));
            let applyEntityList = res.data.applyEntityList;
            applyEntityList.filter(function (element, index, self) {
                if (element.applyStatus == 1 || element.applyStatus == 0) {
                    return true;
                } else {
                    return false;
                }
            });
            if (applyEntityList && applyEntityList.length > 0) {
                applyEntityList.forEach(function (item) {
                    let o = JSON.parse(item.applyData);
                    let extraDatas = [];
                    for (let property in o) {
                        let extraData = new Object();
                        if (o.hasOwnProperty(property)) {
                            extraData.name = property;
                            extraData.value = property;
                            extraDatas.push(extraData);
                        }
                    }
                    item.extraDatas = extraDatas;
                });
                that.setData({
                    applyList: applyEntityList,
                });
            } else {
                app.wxService.showModal({title: "提示", content: "报名数据返回为空"});
            }
        }, function (res) {
            let errorMsg = utils.getErrorMsg(res);
            app.wxService.showModal({title: '报名信息加载失败', content: errorMsg.title + '；' + errorMsg.content});
        }, function (res) {
            console.log(res);
        });
    },
    cancelApply: function (applyId) {//取消报名
        let that = this;
        let cancelReason = ["个人行程有变，参加不了了", "不符合报名条件，主办方拒绝参加", "主办方变更了活动信息",
            "实际情况跟活动信息不符", "主办方取消了活动", "其他原因"]
        wx.showActionSheet({
            itemList: cancelReason,
            success: function (res) {
                let reason = cancelReason[res.tapIndex];
                actApi.cancelApplySelf({
                    data: {
                        actID: activityId,
                        applyID: applyId,
                        reason: reason,
                    }
                }, function (res) {
                    app.wxService.showToast("取消报名成功");
                }, function (res) {
                    let errorMsg = utils.getErrorMsg(res);
                    app.wxService.showModal({title: '取消报名失败', content: errorMsg.title + '；' + errorMsg.content});
                }, function (res) {
                    console.log(res);
                    that.loadApplyList();
                });
            }
        })
    }
})